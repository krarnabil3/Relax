<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</title>
  <meta name="theme-color" content="#061724" />
  <style>
    :root {
      --bg1:#04101A; --bg2:#071C2A;
      --glass: rgba(255,255,255,.09);
      --glass2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --muted2: rgba(255,255,255,.52);
      --blue:#0A84FF; --green:#32D74B; --red:#FF453A; --yellow:#FFD60A;
      --shadow: 0 18px 60px rgba(0,0,0,.46);
      --blur: 20px;
      --rXL: 28px; --rL: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display","SF Pro Text","Segoe UI", Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 18% 0%, rgba(10,132,255,.26), transparent 58%),
        radial-gradient(900px 650px at 110% 10%, rgba(50,215,75,.16), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      -webkit-font-smoothing: antialiased;
      overflow-x:hidden;
    }
    .wrap{max-width:980px;margin:0 auto;padding:max(18px,env(safe-area-inset-top)) 14px 70px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 10px 0}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{width:46px;height:46px;border-radius:16px;flex:none;
      background:
        radial-gradient(circle at 30% 20%, rgba(10,132,255,.95), rgba(10,132,255,.20)),
        radial-gradient(circle at 80% 80%, rgba(50,215,75,.60), rgba(50,215,75,.06));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.22), 0 18px 40px rgba(0,0,0,.30);
    }
    .title h1{margin:0;font-size:20px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .title .sub{margin-top:4px;font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pillbtn{
      border:none;color:var(--text);cursor:pointer;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      padding:10px 14px;border-radius:999px;
      backdrop-filter: blur(var(--blur));
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .card{
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:var(--rXL);
      box-shadow:var(--shadow);
      backdrop-filter: blur(var(--blur));
    }
    .hero{margin:12px 10px 14px;padding:18px}
    .hero h2{margin:0;font-size:22px}
    .hero p{margin:8px 0 0;line-height:1.6;color:var(--muted)}
    .seg{margin-top:14px;display:flex;gap:6px;padding:6px;background:rgba(0,0,0,.16);
      border:1px solid var(--stroke2);border-radius:18px;}
    .seg button{flex:1;border:none;cursor:pointer;padding:12px;border-radius:14px;font-size:15px;
      color:var(--muted);background:transparent;transition:.18s ease;}
    .seg button.active{color:var(--text);background:rgba(255,255,255,.13);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);}
    .status{margin-top:12px;display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:18px;
      background:rgba(0,0,0,.18);border:1px solid var(--stroke2);}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--yellow);box-shadow:0 0 0 4px rgba(255,214,10,.14)}
    .dot.ok{background:var(--green);box-shadow:0 0 0 4px rgba(50,215,75,.14)}
    .dot.bad{background:var(--red);box-shadow:0 0 0 4px rgba(255,69,58,.14)}
    .section{margin:12px 10px;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
    label{display:block;margin:2px 10px 8px;font-size:13px;color:var(--muted)}
    input,select,textarea{width:100%;border-radius:18px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);color:var(--text);padding:14px;font-size:16px;outline:none;}
    textarea{min-height:90px;resize:none}
    .help{margin-top:6px;font-size:12px;color:var(--muted2);padding:0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .btn{flex:1;min-width:170px;cursor:pointer;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.10);color:var(--text);border-radius:18px;padding:14px;font-size:16px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);}
    .btn.primary{background:linear-gradient(180deg, rgba(10,132,255,.95), rgba(10,132,255,.72));
      box-shadow:0 14px 35px rgba(10,132,255,.20);}
    .result{margin-top:14px;padding:14px;border-radius:var(--rL);background:var(--glass2);border:1px solid rgba(255,255,255,.14)}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){.kv{grid-template-columns:1fr}}
    .k{font-size:12px;color:var(--muted2);padding:0 4px}
    .v{font-size:16px;margin-top:4px;padding:0 4px;line-height:1.6;white-space:pre-wrap}
    .hidden{display:none !important}
    img.preview{width:100%;border-radius:18px;border:1px solid rgba(255,255,255,.14)}
    .badge{margin-top:12px;display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:18px;background:rgba(0,0,0,.18);border:1px solid var(--stroke2)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</h1>
          <div class="sub">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† â€¢ Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</div>
        </div>
      </div>
      <button class="pillbtn" id="resetBtn" type="button">Ø¥Ø¹Ø§Ø¯Ø©</button>
    </div>

    <div class="card hero">
      <h2 id="pageTitle">Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</h2>
      <p id="pageDesc">Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†ØŒ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ù„ØµÙˆØ±Ø©.</p>

      <div class="seg" role="tablist">
        <button id="goSearch" class="active" type="button">Ø¨Ø­Ø«</button>
        <button id="goActivate" type="button">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</button>
      </div>

      <div class="status">
        <span class="dot" id="statusDot"></span>
        <span id="cloudStatus" style="color:var(--muted)">... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
      </div>

      <div class="result" id="errBox" style="display:none;direction:ltr;text-align:left;white-space:pre-wrap"></div>
    </div>

    <!-- Search -->
    <div class="card section" id="searchCard">
      <div class="grid">
        <div>
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
          <input id="searchName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" />
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="searchPhone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" inputmode="tel" />
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="searchBtn" type="button">Ø¨Ø­Ø«</button>
        <button class="btn" id="searchClearBtn" type="button">Ù…Ø³Ø­</button>
      </div>

      <div class="result hidden" id="searchResult">
        <div class="kv">
          <div><div class="k">Ø§Ù„Ø§Ø³Ù…</div><div class="v" id="rName">-</div></div>
          <div><div class="k">Ø§Ù„Ù‡Ø§ØªÙ</div><div class="v" id="rPhone">-</div></div>
          <div><div class="k">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</div><div class="v" id="rModel">-</div></div>
          <div><div class="k">Ø§Ù„Ø³Ù„Ø³Ù„Ø©</div><div class="v" id="rSeries">-</div></div>
          <div style="grid-column:1/-1"><div class="k">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div><div class="v" id="rAddress">-</div></div>
          <div style="grid-column:1/-1"><div class="k">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</div><div class="v" id="rEnd">-</div></div>
          <div style="grid-column:1/-1"><div class="k">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div><div class="v" id="rInvoice">-</div></div>
          <div style="grid-column:1/-1" id="rImageWrap" class="hidden">
            <div class="k">Ø§Ù„ØµÙˆØ±Ø©</div>
            <div class="v"><img id="rImage" class="preview" alt="invoice image"/></div>
          </div>
        </div>
        <div class="badge">
          <span class="dot" id="searchDot"></span>
          <span id="searchStatusText">-</span>
        </div>
      </div>
    </div>

    <!-- Activate -->
    <div class="card section hidden" id="activateCard">
      <div class="grid">
        <div>
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
          <input id="fullName" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ±Ø§Ø± Ù†Ø¨ÙŠÙ„ Ø£ÙƒØ±Ù…" />
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="phone" placeholder="0772xxxxxxx Ø£Ùˆ 9647xxxxxxxxx" inputmode="tel" />
        </div>

        <div>
          <label>Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø©</label>
          <input id="model" placeholder="Ù…Ø«Ø§Ù„: 55UHD..." />
        </div>
        <div>
          <label>Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø´Ø§Ø´Ø©</label>
          <select id="series">
            <option value="LGOLED">LGOLED</option>
            <option value="LGUHD" selected>LGUHD</option>
            <option value="LGQNED">LGQNED</option>
            <option value="ILG">ILG</option>
            <option value="PROLG">PROLG</option>
            <option value="GENERAL">GENERAL</option>
            <option value="LGPRO">LGPRO</option>
            <option value="LGDAIMOND">LGDAIMOND</option>
          </select>
        </div>

        <div style="grid-column:1/-1">
          <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <textarea id="address" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© - Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© - Ø§Ù„Ù…Ù†Ø·Ù‚Ø© - Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø© Ø¯Ø§Ù„Ø©"></textarea>
        </div>

        <div style="grid-column:1/-1">
          <label>ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© / Ø§Ù„Ø¬Ù‡Ø§Ø² (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="invoiceImageFile" type="file" accept="image/*" capture="environment" style="padding:12px" />
          <div class="help">ØªØ´ØªØºÙ„ Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ù…Ù„ÙØ§ØªØŒ ÙˆØªÙ†Ø­ÙØ¸ ÙˆØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ø¨Ø­Ø«.</div>
          <div class="result hidden" id="imgPreviewBox" style="margin-top:10px">
            <div class="k">Ù…Ø¹Ø§ÙŠÙ†Ø©</div>
            <div class="v"><img id="imgPreview" class="preview" /></div>
          </div>
        </div>

        <div>
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="itemsCount" placeholder="Ù…Ø«Ø§Ù„: 1" inputmode="numeric" />
        </div>
        <div>
          <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ + Ø§Ù„Ù†Ù‚Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="grandTotal" placeholder="Ù…Ø«Ø§Ù„: 180,000" />
        </div>
        <div style="grid-column:1/-1">
          <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="itemsText" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ù„ØµÙ‚ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯..."></textarea>
        </div>

        <div>
          <label>ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="code" placeholder="DG-25A7K9" />
        </div>
        <div>
          <label>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</label>
          <button class="btn" id="callHelp" type="button">Ø§ØªØµØ§Ù„: 9647722806645</button>
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="activateBtn" type="button">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</button>
        <button class="btn" id="copyBtn" type="button">Ù†Ø³Ø®</button>
      </div>

      <div class="result hidden" id="resultBox">
        <div class="kv">
          <div><div class="k">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¶Ù…Ø§Ù†</div><div class="v" id="startDate">-</div></div>
          <div><div class="k">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</div><div class="v" id="endDate">-</div></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {"apiKey": "AIzaSyBMZbRFRU5-GyAmEwLHDspnY6PkEcaz6Ak", "authDomain": "albaman-f8a20.firebaseapp.com", "projectId": "albaman-f8a20", "storageBucket": "albaman-f8a20.firebasestorage.app", "messagingSenderId": "770267943286", "appId": "1:770267943286:web:e3da1c43d65740d7b52a57", "measurementId": "G-CB2PYMZSZT"};
    const HELP_PHONE = "9647722806645";
    const WARRANTY_DAYS = 365;

    const $ = (id)=>document.getElementById(id);

    function setConn(state, msg){
      const dot = $("statusDot");
      dot.className = "dot" + (state==="ok" ? " ok" : state==="bad" ? " bad" : "");
      $("cloudStatus").textContent = msg;
    }
    function showErr(msg){
      const el = $("errBox");
      if(!msg){ el.style.display="none"; el.textContent=""; return; }
      el.style.display="block"; el.textContent = String(msg);
    }
    function normalizeDigits(str){
      return (str||"")
        .replace(/[Ù -Ù©]/g, d => String("Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d)))
        .replace(/[Û°-Û¹]/g, d => String("Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)));
    }
    function sanitizePhone(p){ return normalizeDigits((p||"").trim().replace(/\s+/g,"")); }
    function normalizeName(n){ return (n||"").trim().replace(/\s+/g," "); }

    function fmt(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const da=String(d.getDate()).padStart(2,"0");
      const hh=String(d.getHours()).padStart(2,"0");
      const mm=String(d.getMinutes()).padStart(2,"0");
      return `${y}-${m}-${da} ${hh}:${mm}`;
    }

    function showSearch(){
      $("searchCard").classList.remove("hidden");
      $("activateCard").classList.add("hidden");
      $("goSearch").classList.add("active");
      $("goActivate").classList.remove("active");
      $("pageTitle").textContent="Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†";
      $("pageDesc").textContent="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†ØŒ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ù„ØµÙˆØ±Ø©.";
      window.scrollTo({top:0, behavior:"smooth"});
    }
    function showActivate(){
      $("activateCard").classList.remove("hidden");
      $("searchCard").classList.add("hidden");
      $("goActivate").classList.add("active");
      $("goSearch").classList.remove("active");
      $("pageTitle").textContent="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†";
      $("pageDesc").textContent="Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø±ÙØ¹ ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø«Ù… Ø§Ø¶ØºØ· ØªÙØ¹ÙŠÙ„.";
      window.scrollTo({top:0, behavior:"smooth"});
    }

    $("goSearch").addEventListener("click", showSearch);
    $("goActivate").addEventListener("click", showActivate);

    $("resetBtn").addEventListener("click", ()=>{
      ["fullName","phone","model","address","code","itemsCount","grandTotal","itemsText","searchName","searchPhone"].forEach(id=>{ const el=$(id); if(el) el.value=""; });
      $("searchResult").classList.add("hidden");
      $("resultBox").classList.add("hidden");
      $("imgPreviewBox").classList.add("hidden");
      window.__invoiceImageData = null;
      showSearch();
    });

    $("searchClearBtn").addEventListener("click", ()=>{
      $("searchName").value=""; $("searchPhone").value="";
      $("searchResult").classList.add("hidden");
    });

    $("callHelp").addEventListener("click", ()=> location.href = "tel:" + HELP_PHONE);

    // ---- Image (camera or files) -> Base64 (JPEG) + preview ----
    window.__invoiceImageData = null;

    async function fileToCompressedDataURL(file, maxSide=1400, quality=0.78){
      const img = new Image();
      const url = URL.createObjectURL(file);
      await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; img.src=url; });
      const w = img.naturalWidth, h = img.naturalHeight;
      const scale = Math.min(1, maxSide / Math.max(w,h));
      const nw = Math.round(w*scale), nh = Math.round(h*scale);
      const canvas = document.createElement("canvas");
      canvas.width=nw; canvas.height=nh;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img,0,0,nw,nh);
      URL.revokeObjectURL(url);
      return canvas.toDataURL("image/jpeg", quality);
    }

    $("invoiceImageFile").addEventListener("change", async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file){ window.__invoiceImageData=null; $("imgPreviewBox").classList.add("hidden"); return; }
      try{
        const dataUrl = await fileToCompressedDataURL(file);
        window.__invoiceImageData = dataUrl;
        $("imgPreview").src = dataUrl;
        $("imgPreviewBox").classList.remove("hidden");
      }catch(err){
        alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©");
        console.log(err);
      }
    });

    // ---- Firestore ----
    let db = null;
    try{
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    }catch(e){
      setConn("bad","âŒ Ø®Ø·Ø£ Ø¨ØªÙ‡ÙŠØ¦Ø© Firebase");
      showErr(e?.message || e);
    }

    async function ping(){
      if(!db) return;
      try{
        await db.collection("_health").doc("ping").get();
        setConn("ok","âœ… Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firestore)");
        showErr("");
      }catch(e){
        setConn("bad","âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        showErr((e?.code?e.code:"error")+": "+(e?.message||e));
      }
    }
    setConn("warn","... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    ping();

    async function sha256hex(s){
      const enc = new TextEncoder().encode(s);
      const hash = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    // doc id default: name|phone
    async function docIdBase(name, phone){
      return sha256hex(normalizeName(name).toLowerCase() + "|" + sanitizePhone(phone));
    }

    // if force-new needed, we append model
    async function docIdWithModel(name, phone, model){
      return sha256hex(normalizeName(name).toLowerCase() + "|" + sanitizePhone(phone) + "|" + (model||"").toLowerCase());
    }

    $("activateBtn").addEventListener("click", async ()=>{
      const fullName = normalizeName($("fullName").value);
      const phone = sanitizePhone($("phone").value);
      const model = ($("model").value||"").trim();
      const address = ($("address").value||"").trim();
      const series = ($("series").value||"").trim();
      const code = ($("code").value||"").trim() || null;
      const itemsCount = ($("itemsCount").value||"").trim() || null;
      const grandTotal = ($("grandTotal").value||"").trim() || null;
      const itemsText = ($("itemsText").value||"").trim() || null;
      const invoiceImage = window.__invoiceImageData || null;

      if(fullName.split(" ").length < 3) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ (3 ÙƒÙ„Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).");
      if(phone.length < 10) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­.");
      if(!model) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø².");
      if(!address) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„.");
      if(!db) return alert("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");

      try{
        // 1) check exact same customer (name+phone)
        const baseId = await docIdBase(fullName, phone);
        const baseRef = db.collection("warranties").doc(baseId);
        const baseSnap = await baseRef.get();

        if(baseSnap.exists){
          const d = baseSnap.data() || {};
          const end = d.endISO ? new Date(d.endISO) : null;
          alert(
            "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ âœ…\n\n" +
            "Ø§Ù„Ø§Ø³Ù…: " + (d.fullName||"-") + "\n" +
            "Ø§Ù„Ù‡Ø§ØªÙ: " + (d.phone||"-") + "\n" +
            "Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: " + (d.model||"-") + "\n" +
            "Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†: " + (end ? fmt(end) : "-")
          );
          $("searchName").value = d.fullName || fullName;
          $("searchPhone").value = d.phone || phone;
          showSearch();
          return;
        }

        // 2) same phone used before -> allow open old OR continue as NEW
        const q = await db.collection("warranties").where("phone","==",phone).limit(1).get();
        let allowNew = true;
        if(!q.empty){
          const d = q.docs[0].data() || {};
          const end = d.endISO ? new Date(d.endISO) : null;
          const choice = prompt(
            "Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù‘Ù„ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ù„Ø²Ø¨ÙˆÙ†.\n\n" +
            "Ø§Ù„Ø§Ø³Ù…: " + (d.fullName||"-") + "\n" +
            "Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: " + (d.model||"-") + "\n" +
            "Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†: " + (end ? fmt(end) : "-") + "\n\n" +
            "Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø®ÙŠØ§Ø±:\n" +
            "1) ÙØªØ­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚\n" +
            "2) ØªØ«Ø¨ÙŠØª ÙƒØ²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯"
          );
          const c = (normalizeDigits(choice||"").trim());
          if(c === "1"){
            $("searchName").value = d.fullName || "";
            $("searchPhone").value = d.phone || phone;
            showSearch();
            $("searchBtn").click();
            return;
          }
          if(c !== "2") return; // cancel
        }

        // create new doc (baseId) since not exists. If phone had old, still new doc by model-based id to avoid collision
        let idToUse = baseId;
        if(!q.empty){
          idToUse = await docIdWithModel(fullName, phone, model);
        }
        const ref = db.collection("warranties").doc(idToUse);
        const snap = await ref.get();
        if(snap.exists){
          alert("Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„). Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙ‘Ø± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø£Ùˆ Ø§ÙØªØ­ Ø§Ù„Ø¨Ø­Ø«.");
          return;
        }

        const start = new Date();
        const end = new Date(start);
        end.setDate(end.getDate() + WARRANTY_DAYS);

        await ref.set({
          fullName, phone, model, address, series, code,
          invoice: { itemsCount, grandTotal, itemsText },
          invoiceImage,
          startISO: start.toISOString(),
          endISO: end.toISOString(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        $("resultBox").classList.remove("hidden");
        $("startDate").textContent = fmt(start);
        $("endDate").textContent = fmt(end);

        alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† âœ…");

      }catch(e){
        alert("Ø®Ø·Ø£: " + (e?.message || e));
        console.log(e);
      }
    });

    $("searchBtn").addEventListener("click", async ()=>{
      const name = normalizeName($("searchName").value);
      const phone = sanitizePhone($("searchPhone").value);
      if(name.split(" ").length < 3) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ.");
      if(phone.length < 10) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.");
      if(!db) return alert("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");

      try{
        // Try exact match first
        const id = await docIdBase(name, phone);
        let snap = await db.collection("warranties").doc(id).get();

        // if not found, try by phone only (latest one)
        if(!snap.exists){
          const q = await db.collection("warranties").where("phone","==",phone).limit(10).get();
          if(q.empty){
            $("searchResult").classList.add("hidden");
            alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª.");
            return;
          }
          // pick the first (not perfect ordering in static, but ok)
          snap = q.docs[0];
        }

        const d = snap.data() || {};
        $("rName").textContent = d.fullName || "-";
        $("rPhone").textContent = d.phone || "-";
        $("rModel").textContent = d.model || "-";
        $("rSeries").textContent = d.series || "-";
        $("rAddress").textContent = d.address || "-";
        const end = d.endISO ? new Date(d.endISO) : null;
        $("rEnd").textContent = end ? fmt(end) : "-";

        const inv = d.invoice || {};
        const lines = [];
        if(inv.itemsCount) lines.push("Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯: " + inv.itemsCount);
        if(inv.grandTotal) lines.push("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ + Ø§Ù„Ù†Ù‚Ù„: " + inv.grandTotal);
        if(inv.itemsText) lines.push("Ø§Ù„ØªÙØ§ØµÙŠÙ„:\n" + inv.itemsText);
        $("rInvoice").textContent = lines.length ? lines.join("\n\n") : "â€”";

        const imgWrap = $("rImageWrap");
        if(d.invoiceImage){
          $("rImage").src = d.invoiceImage;
          imgWrap.classList.remove("hidden");
        }else{
          imgWrap.classList.add("hidden");
        }

        const active = end ? (new Date() <= end) : false;
        $("searchDot").className = active ? "dot ok" : "dot bad";
        $("searchStatusText").textContent = active ? "ğŸŸ¢ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù†" : "ğŸ”´ Ø§Ù„Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù†Ø§ÙØ°";

        $("searchResult").classList.remove("hidden");
      }catch(e){
        alert("Ø®Ø·Ø£: " + (e?.message || e));
        console.log(e);
      }
    });

    $("copyBtn").addEventListener("click", async ()=>{
      const t =
        "Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©\n" +
        "Ø§Ù„Ø§Ø³Ù…: " + ($("fullName").value||"") + "\n" +
        "Ø§Ù„Ù‡Ø§ØªÙ: " + ($("phone").value||"") + "\n" +
        "Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: " + ($("model").value||"") + "\n" +
        "Ø§Ù„Ø³Ù„Ø³Ù„Ø©: " + ($("series").value||"") + "\n" +
        "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: " + ($("address").value||"");
      try{ await navigator.clipboard.writeText(t); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“"); }
      catch(_ ){ alert(t); }
    });

    // start page
    showSearch();
  </script>
</body>
</html>
