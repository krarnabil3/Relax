<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</title>
  <style>
    :root{
      --bg1:#06283b; --bg2:#0b3a54;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --blue:#1a86ff;
      --good:#29d67a;
      --warn:#ffcc00;
      --bad:#ff5a5a;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 30% 10%, rgba(46,160,255,.22), transparent 55%),
                  radial-gradient(900px 500px at 80% 20%, rgba(41,214,122,.14), transparent 60%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--txt);
      min-height:100vh;
      padding: 18px 14px 26px;
    }
    .wrap{max-width:520px; margin:0 auto;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 6px 2px 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:46px; height:46px; border-radius:16px;
      background: radial-gradient(circle at 25% 25%, rgba(255,255,255,.35), transparent 45%),
                  linear-gradient(135deg, rgba(26,134,255,.95), rgba(41,214,122,.85));
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    .brand h1{margin:0; font-size:20px; font-weight:800; letter-spacing:.2px}
    .brand p{margin:2px 0 0; font-size:13px; color:var(--muted)}
    .btnSmall{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 14px; border-radius:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      cursor:pointer;
    }
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border-radius: var(--r);
      padding: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .sectionTitle{margin:0 0 8px; font-size:22px; font-weight:900}
    .sectionSub{margin:0 0 12px; color:var(--muted)}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .actions{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;}
    .btn{
      border:1px solid var(--stroke);
      border-radius: 18px;
      padding: 14px 14px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      color:var(--txt);
      background: rgba(255,255,255,.06);
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(26,134,255,.95), rgba(26,134,255,.65));
      border-color: rgba(26,134,255,.85);
      box-shadow: 0 18px 45px rgba(26,134,255,.22);
    }
    .btn:active{transform: translateY(1px)}
    .status{
      display:flex; align-items:center; justify-content:space-between;
      margin-top:10px;
      padding:12px 14px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--muted);
    }
    .dot{width:10px; height:10px; border-radius:50%; background: var(--warn); box-shadow: 0 0 0 4px rgba(255,204,0,.12);}
    .dot.good{background: var(--good); box-shadow: 0 0 0 4px rgba(41,214,122,.12);}
    .dot.bad{background: var(--bad); box-shadow: 0 0 0 4px rgba(255,90,90,.12);}
    label{display:block; font-size:13px; color:var(--muted); margin: 14px 0 8px;}
    input, textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      padding: 13px 14px;
      border-radius: 16px;
      outline:none;
      font-size:16px;
    }
    textarea{min-height:88px; resize:vertical}
    .hint{margin-top:6px; font-size:12px; color:var(--muted2)}
    .divider{height:12px}
    .resultCard{
      margin-top:14px;
      border-radius: var(--r);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      padding: 14px;
    }
    .kpi{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px}
    .pill{padding:10px 12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06)}
    .pill b{display:block; font-size:13px; color:var(--muted)}
    .pill span{display:block; margin-top:4px; font-size:15px; font-weight:800}
    .small{font-size:12px; color:var(--muted2)}

    /* views */
    .view{display:none}
    .view.active{display:block}

    /* welcome overlay */
    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 600px at 30% 10%, rgba(46,160,255,.22), transparent 55%),
                  radial-gradient(900px 500px at 80% 20%, rgba(41,214,122,.14), transparent 60%),
                  linear-gradient(180deg, rgba(6,40,59,.92), rgba(11,58,84,.92));
      z-index: 9999;
      padding: 22px 14px;
    }
    .overlayCard{
      width:min(520px, 100%);
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border-radius: 26px;
      box-shadow: 0 22px 80px rgba(0,0,0,.45);
      padding: 18px;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      overflow:hidden;
      position:relative;
    }
    .sparkles{
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.18), transparent 40%),
        radial-gradient(circle at 80% 20%, rgba(26,134,255,.35), transparent 45%),
        radial-gradient(circle at 70% 80%, rgba(41,214,122,.22), transparent 45%),
        radial-gradient(circle at 30% 85%, rgba(255,204,0,.18), transparent 50%);
      filter: blur(1px);
      opacity:.9;
      animation: floatbg 6s ease-in-out infinite;
    }
    @keyframes floatbg{ 0%{transform:translateY(0)} 50%{transform:translateY(10px)} 100%{transform:translateY(0)} }
    .overlayHeader{
      position:relative;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .overlayTitle{margin:0; font-size:18px; font-weight:900}
    .xbtn{
      position:relative;
      width:44px; height:44px; border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:18px; font-weight:900;
    }
    .hero{
      position:relative;
      padding: 10px 2px 0;
    }
    .confetti{
      position:absolute; inset: -20px -10px auto -10px; height:120px; pointer-events:none;
    }
    .confetti span{
      position:absolute; width:10px; height:16px; border-radius:4px;
      opacity:.9;
      animation: fall 1.8s linear infinite;
    }
    @keyframes fall {
      0%{transform: translateY(-30px) rotate(0deg); opacity:0}
      10%{opacity:1}
      100%{transform: translateY(140px) rotate(240deg); opacity:0}
    }
    .msg{
      margin: 10px 0 0;
      line-height:1.8;
      color:var(--txt);
      font-size:15px;
      text-align:center;
    }
    .msg b{font-size:18px}
    .overlayActions{display:grid; grid-template-columns:1fr; gap:10px; margin-top:14px}
    .overlayNote{text-align:center; color:var(--muted); font-size:12px; margin-top:6px}

    /* password modal */
    .modalWrap{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.45);
      z-index: 9998;
      padding: 18px 14px;
    }
    .modalWrap.show{display:flex}
    .modal{
      width:min(420px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(15, 60, 86, .92), rgba(10, 38, 55, .92));
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      padding: 16px;
    }
    .modal h3{margin:0 0 6px; font-size:18px}
    .modal p{margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.6}
    .modal .row{display:flex; gap:10px; margin-top:10px}
    .modal .row button{flex:1}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: 18px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--txt);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      opacity:0; pointer-events:none;
      transition: opacity .25s ease;
      z-index: 10000;
      font-size:14px;
      max-width:min(520px, 92vw);
      text-align:center;
    }
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <!-- Welcome Overlay -->
  <div id="welcomeOverlay" class="overlay">
    <div class="overlayCard">
      <div class="sparkles"></div>

      <div class="overlayHeader">
        <div style="display:flex; align-items:center; gap:10px; position:relative;">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <div class="overlayTitle">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</div>
            <div class="small">Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</div>
          </div>
        </div>
        <button class="xbtn" id="welcomeClose" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
      </div>

      <div class="hero">
        <div class="confetti" id="confetti"></div>
        <p class="msg">
          <b>Ù…Ø¨Ø±ÙˆÙƒ!</b> Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø´Ø±Ø§Ø¡ Ø¬Ù‡Ø§Ø² Ø£ØµÙ„ÙŠ âœ…<br/>
          Ø¶Ù…Ø§Ù† Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù…Ø¯Ø© <b>Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©</b> Ù…Ø¹ Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ®Ø¯Ù…Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©.<br/>
          <span class="small">Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø¨Ø­Ø« Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¶Ù…Ø§Ù†ØŒ Ø£Ùˆ ÙØ¹Ù‘Ù„ Ø§Ù„Ø¶Ù…Ø§Ù† (Ù…Ù‚ÙÙ„ Ø¨ÙƒÙ„Ù…Ø© Ø³Ø±).</span>
        </p>
      </div>

      <div class="overlayActions">
        <button class="btn primary" id="welcomeContinue">Ù…ØªØ§Ø¨Ø¹Ø©</button>
      </div>
      <div class="overlayNote">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø²Ø± Ã— Ø£Ùˆ Ù…ØªØ§Ø¨Ø¹Ø©.</div>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="passModalWrap" class="modalWrap" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ø·Ù„ÙˆØ¨Ø©</h3>
      <p>Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ ØµÙØ­Ø© <b>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</b> Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.</p>
      <input id="passInput" type="password" inputmode="numeric" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="off" />
      <div class="row">
        <button class="btn" id="passCancel">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn primary" id="passOk">ØªØ£ÙƒÙŠØ¯</button>
      </div>
      <div class="hint" id="passHint" style="display:none; color: var(--bad); margin-top:10px;">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</h1>
          <p>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† â€¢ Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</p>
        </div>
      </div>
      <button class="btnSmall" id="btnReset">Ø¥Ø¹Ø§Ø¯Ø©</button>
    </div>

    <div class="card">
      <div id="viewSearch" class="view active">
        <h2 class="sectionTitle">Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</h2>
        <p class="sectionSub">Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† (Ù…Ø¹ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡).</p>

        <label for="searchName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
        <input id="searchName" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ±Ø§Ø± Ù†Ø¨ÙŠÙ„ Ø£ÙƒØ±Ù…" />
        <label for="searchPhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input id="searchPhone" inputmode="tel" placeholder="Ù…Ø«Ø§Ù„: 077XXXXXXXXX" />

        <div class="actions">
          <button class="btn primary" id="btnSearch">Ø¨Ø­Ø«</button>
          <button class="btn" id="btnGoActivate">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</button>
        </div>

        <div class="status">
          <div style="display:flex; align-items:center; gap:10px;">
            <div id="dbDot" class="dot"></div>
            <div id="dbText">... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
          </div>
          <div class="small" id="dbMode"></div>
        </div>

        <div id="searchResult" class="resultCard" style="display:none;"></div>
      </div>

      <div id="viewActivate" class="view">
        <h2 class="sectionTitle">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</h2>
        <p class="sectionSub">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†" Ù„ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù…Ø¯Ø© Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©.</p>

        <label for="actName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
        <input id="actName" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ±Ø§Ø± Ù†Ø¨ÙŠÙ„ Ø£ÙƒØ±Ù…" />

        <label for="actPhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input id="actPhone" inputmode="tel" placeholder="Ù…Ø«Ø§Ù„: 077XXXXXXXXX" />
        <div class="hint">ÙŠÙØ¶Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø¨ØµÙŠØºØ© Ù…Ø­Ù„ÙŠØ© ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù…Ø«Ø§Ù„.</div>

        <label for="actModel">Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²</label>
        <input id="actModel" placeholder="Ù…Ø«Ø§Ù„: 55UHD-2025" />

        <label for="actAddress">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„</label>
        <textarea id="actAddress" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© - Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© - Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ..."></textarea>

        <div class="actions">
          <button class="btn primary" id="btnActivateNow">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</button>
          <button class="btn" id="btnBackSearch">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <div id="activateMsg" class="hint" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <!-- Firebase (Compat to avoid module issues on Vercel static hosting) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ====== CONFIG ======
    const FIREBASE_CONFIG = {"apiKey": "AIzaSyBMZbRFRU5-GyAmEwLHDspnY6PkEcaz6Ak", "authDomain": "albaman-f8a20.firebaseapp.com", "projectId": "albaman-f8a20", "storageBucket": "albaman-f8a20.firebasestorage.app", "messagingSenderId": "770267943286", "appId": "1:770267943286:web:e3da1c43d65740d7b52a57", "measurementId": "G-CB2PYMZSZT"};
    const ADMIN_PASS = "878705";
    const WARRANTY_DAYS = 365;

    // ====== HELPERS ======
    const $ = (id) => document.getElementById(id);

    function norm(str) {
      return (str || "").toString().trim().replace(/\s+/g, " ");
    }
    function normPhone(p) {
      return (p || "").toString().trim().replace(/\s+/g, "");
    }
    function makeKey(name, phone) {
      return (norm(name) + "||" + normPhone(phone)).toLowerCase();
    }
    function fmtDateTime(dt) {
      // dt is JS Date
      const pad = (n) => String(n).padStart(2,'0');
      return `${pad(dt.getHours())}:${pad(dt.getMinutes())}  ${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
    }
    function addDays(date, days) {
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + days);
      return d;
    }
    function toast(msg) {
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => t.classList.remove("show"), 2200);
    }

    // ====== WELCOME MOTION ======
    function buildConfetti() {
      const box = $("confetti");
      if (!box) return;
      box.innerHTML = "";
      const colors = ["rgba(26,134,255,.95)","rgba(41,214,122,.9)","rgba(255,204,0,.9)","rgba(255,255,255,.75)"];
      for (let i=0;i<18;i++) {
        const s = document.createElement("span");
        const c = colors[i % colors.length];
        s.style.background = c;
        s.style.left = (Math.random()*100) + "%";
        s.style.top = (Math.random()*10) + "px";
        s.style.animationDelay = (Math.random()*0.9) + "s";
        s.style.animationDuration = (1.4 + Math.random()*1.2) + "s";
        s.style.transform = `translateY(-30px) rotate(${Math.random()*120}deg)`;
        box.appendChild(s);
      }
    }

    // ====== VIEW CONTROL ======
    function showView(which) {
      $("viewSearch").classList.toggle("active", which === "search");
      $("viewActivate").classList.toggle("active", which === "activate");
      window.scrollTo({top:0, behavior:"smooth"});
    }

    // ====== PASSWORD FLOW ======
    function openPassModal(onOk) {
      $("passHint").style.display = "none";
      $("passInput").value = "";
      $("passModalWrap").classList.add("show");
      $("passModalWrap").setAttribute("aria-hidden","false");
      setTimeout(() => $("passInput").focus(), 30);

      window.__passOk = () => {
        const v = ($("passInput").value || "").trim();
        if (v !== ADMIN_PASS) {
          $("passHint").style.display = "block";
          $("passInput").focus();
          return;
        }
        closePassModal();
        onOk?.();
      };
    }
    function closePassModal() {
      $("passModalWrap").classList.remove("show");
      $("passModalWrap").setAttribute("aria-hidden","true");
      window.__passOk = null;
    }

    // ====== FIREBASE INIT ======
    let app, db;
    function setDbStatus(state, msg) {
      const dot = $("dbDot");
      dot.classList.remove("good","bad");
      if (state === "good") dot.classList.add("good");
      if (state === "bad") dot.classList.add("bad");
      $("dbText").textContent = msg;
    }

    async function initFirebase() {
      try {
        app = firebase.initializeApp(FIREBASE_CONFIG);
        db = firebase.firestore();

        // quick ping: read a tiny doc (will fail if rules deny)
        setDbStatus("warn", "... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        $("dbMode").textContent = "";

        const pingRef = db.collection("_meta").doc("ping");
        await pingRef.set({ t: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

        setDbStatus("good", "Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firestore)");
      } catch (e) {
        console.error(e);
        setDbStatus("bad", "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        $("dbMode").textContent = (e && e.message) ? e.message : "";
      }
    }

    // ====== DATA OPS ======
    async function upsertWarranty({ name, phone, model, address }) {
      if (!db) throw new Error("DB_NOT_READY");

      const key = makeKey(name, phone);
      const docRef = db.collection("warranties").doc(key);

      const now = new Date();
      const end = addDays(now, WARRANTY_DAYS);
      const purchase = {
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAtClient: now.toISOString(),
        model: norm(model),
        address: norm(address),
        warrantyEndClient: end.toISOString(),
      };

      await db.runTransaction(async (tx) => {
        const snap = await tx.get(docRef);
        if (!snap.exists) {
          tx.set(docRef, {
            name: norm(name),
            phone: normPhone(phone),
            key,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            purchases: [purchase],
            purchaseCount: 1,
            lastWarrantyEndClient: end.toISOString(),
          });
        } else {
          const data = snap.data() || {};
          const prev = Array.isArray(data.purchases) ? data.purchases : [];
          const next = prev.concat([purchase]);
          tx.update(docRef, {
            name: norm(name),
            phone: normPhone(phone),
            purchases: next,
            purchaseCount: (data.purchaseCount || next.length),
            lastWarrantyEndClient: end.toISOString(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });
        }
      });

      return { key, end };
    }

    async function findWarranty(name, phone) {
      if (!db) throw new Error("DB_NOT_READY");
      const key = makeKey(name, phone);
      const snap = await db.collection("warranties").doc(key).get();
      if (!snap.exists) return null;
      return snap.data();
    }

    function renderResult(data) {
      const box = $("searchResult");
      if (!data) {
        box.style.display = "block";
        box.innerHTML = `<div style="font-weight:900; margin-bottom:6px;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¶Ù…Ø§Ù†</div>
          <div class="small">ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø«Ù„ Ù…Ø§ ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ù….</div>`;
        return;
      }

      const purchases = Array.isArray(data.purchases) ? data.purchases : [];
      const count = data.purchaseCount || purchases.length || 0;

      // last warranty end (client)
      let lastEndISO = data.lastWarrantyEndClient;
      if (!lastEndISO && purchases.length) {
        lastEndISO = purchases[purchases.length-1]?.warrantyEndClient;
      }
      let lastEndText = "-";
      let remainingText = "-";
      let activeText = "-";
      if (lastEndISO) {
        const end = new Date(lastEndISO);
        lastEndText = fmtDateTime(end);
        const now = new Date();
        const diffMs = end.getTime() - now.getTime();
        const diffDays = Math.ceil(diffMs / (1000*60*60*24));
        if (diffDays >= 0) {
          activeText = "Ø¶Ù…Ù† Ø§Ù„Ø¶Ù…Ø§Ù† âœ…";
          remainingText = `${diffDays} ÙŠÙˆÙ…`;
        } else {
          activeText = "Ù…Ù†ØªÙ‡ÙŠ âŒ";
          remainingText = `${Math.abs(diffDays)} ÙŠÙˆÙ… Ù…Ø¶Øª`;
        }
      }

      const list = purchases.slice().reverse().map((p, idx) => {
        const createdISO = p.createdAtClient || "";
        const created = createdISO ? new Date(createdISO) : null;
        const endISO = p.warrantyEndClient || "";
        const end = endISO ? new Date(endISO) : null;
        return `
          <div style="padding:10px 12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); margin-top:10px;">
            <div class="small">Ø´Ø±Ø§Ø¡ #${(count - idx)}</div>
            <div style="display:grid; grid-template-columns:1fr; gap:6px; margin-top:6px;">
              <div><span class="small">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„:</span> <b>${(p.model||"-")}</b></div>
              <div><span class="small">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span> <b>${(p.address||"-")}</b></div>
              <div><span class="small">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡:</span> <b>${created ? fmtDateTime(created) : "-"}</b></div>
              <div><span class="small">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†:</span> <b>${end ? fmtDateTime(end) : "-"}</b></div>
            </div>
          </div>
        `;
      }).join("");

      box.style.display = "block";
      box.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div>
            <div class="small">Ø§Ù„Ø§Ø³Ù…</div>
            <div style="font-weight:900; font-size:18px;">${data.name || "-"}</div>
          </div>
          <div style="text-align:left;">
            <div class="small">Ø§Ù„Ù‡Ø§ØªÙ</div>
            <div style="font-weight:900; font-size:18px; direction:ltr;">${data.phone || "-"}</div>
          </div>
        </div>

        <div class="kpi">
          <div class="pill"><b>Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</b><span>${activeText}</span></div>
          <div class="pill"><b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ / Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ</b><span>${remainingText}</span></div>
          <div class="pill"><b>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</b><span>${lastEndText}</span></div>
          <div class="pill"><b>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</b><span>${count} Ù…Ø±Ø©</span></div>
        </div>

        <div style="margin-top:12px; font-weight:900;">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
        ${purchases.length ? list : '<div class="small" style="margin-top:6px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù…Ø´ØªØ±ÙŠØ§Øª.</div>'}
      `;
    }

    // ====== EVENTS ======
    function bindEvents() {
      // welcome
      buildConfetti();
      $("welcomeContinue").addEventListener("click", () => {
        $("welcomeOverlay").style.display = "none";
      });
      $("welcomeClose").addEventListener("click", () => {
        $("welcomeOverlay").style.display = "none";
      });

      // reset
      $("btnReset").addEventListener("click", () => {
        $("searchName").value = "";
        $("searchPhone").value = "";
        $("actName").value = "";
        $("actPhone").value = "";
        $("actModel").value = "";
        $("actAddress").value = "";
        $("searchResult").style.display = "none";
        $("activateMsg").textContent = "";
        showView("search");
        toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©");
      });

      // navigation
      $("btnBackSearch").addEventListener("click", () => showView("search"));

      // open activation (LOCKED)
      $("btnGoActivate").addEventListener("click", () => {
        openPassModal(() => {
          showView("activate");
        });
      });

      // password modal buttons
      $("passCancel").addEventListener("click", closePassModal);
      $("passOk").addEventListener("click", () => window.__passOk && window.__passOk());
      $("passModalWrap").addEventListener("click", (e) => {
        if (e.target === $("passModalWrap")) closePassModal();
      });
      $("passInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          window.__passOk && window.__passOk();
        }
        if (e.key === "Escape") closePassModal();
      });

      // Search
      $("btnSearch").addEventListener("click", async () => {
        const name = norm($("searchName").value);
        const phone = normPhone($("searchPhone").value);
        if (!name || !phone) {
          toast("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
          return;
        }
        try {
          $("btnSearch").disabled = true;
          $("btnSearch").textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";
          const data = await findWarranty(name, phone);
          renderResult(data);
        } catch (e) {
          console.error(e);
          toast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø¨Ø­Ø«");
        } finally {
          $("btnSearch").disabled = false;
          $("btnSearch").textContent = "Ø¨Ø­Ø«";
        }
      });

      // Activate
      $("btnActivateNow").addEventListener("click", async () => {
        const name = norm($("actName").value);
        const phone = normPhone($("actPhone").value);
        const model = norm($("actModel").value);
        const address = norm($("actAddress").value);
        if (!name || !phone) {
          toast("Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†");
          return;
        }
        if (!db) {
          toast("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©");
          return;
        }
        try {
          $("btnActivateNow").disabled = true;
          $("btnActivateNow").textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
          const { end } = await upsertWarranty({ name, phone, model, address });
          $("activateMsg").style.color = "var(--good)";
          $("activateMsg").textContent = "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†: " + fmtDateTime(end);
          toast("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†");
          // prefill search
          $("searchName").value = name;
          $("searchPhone").value = phone;
          // show result
          const data = await findWarranty(name, phone);
          renderResult(data);
          showView("search");
        } catch (e) {
          console.error(e);
          $("activateMsg").style.color = "var(--bad)";
          $("activateMsg").textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + (e?.message || "Ø®Ø·Ø£");
          toast("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
        } finally {
          $("btnActivateNow").disabled = false;
          $("btnActivateNow").textContent = "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†";
        }
      });
    }

    // ====== START ======
    window.addEventListener("DOMContentLoaded", async () => {
      bindEvents();
      await initFirebase();
    });
  </script>
</body>
</html>
