<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</title>
  <meta name="theme-color" content="#061724" />
  <style>
    :root {
      --bg1:#04101A; --bg2:#071C2A;
      --glass: rgba(255,255,255,.09);
      --glass2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --muted2: rgba(255,255,255,.52);
      --blue:#0A84FF; --green:#32D74B; --red:#FF453A; --yellow:#FFD60A;
      --shadow: 0 18px 60px rgba(0,0,0,.46);
      --blur: 20px;
      --rXL: 28px; --rL: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display","SF Pro Text","Segoe UI", Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 18% 0%, rgba(10,132,255,.26), transparent 58%),
        radial-gradient(900px 650px at 110% 10%, rgba(50,215,75,.16), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      -webkit-font-smoothing: antialiased;
      overflow-x:hidden;
    }
    .wrap{max-width:980px;margin:0 auto;padding:max(18px,env(safe-area-inset-top)) 14px 70px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 10px 0}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{width:46px;height:46px;border-radius:16px;flex:none;
      background:
        radial-gradient(circle at 30% 20%, rgba(10,132,255,.95), rgba(10,132,255,.20)),
        radial-gradient(circle at 80% 80%, rgba(50,215,75,.60), rgba(50,215,75,.06));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.22), 0 18px 40px rgba(0,0,0,.30);
    }
    .title h1{margin:0;font-size:20px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .title .sub{margin-top:4px;font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pillbtn{
      border:none;color:var(--text);cursor:pointer;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      padding:10px 14px;border-radius:999px;
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .card{
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:var(--rXL);
      box-shadow:var(--shadow);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
    }
    .hero{margin:12px 10px 14px;padding:18px}
    .hero h2{margin:0;font-size:22px}
    .hero p{margin:8px 0 0;line-height:1.6;color:var(--muted)}
    .seg{margin-top:14px;display:flex;gap:6px;padding:6px;background:rgba(0,0,0,.16);
      border:1px solid var(--stroke2);border-radius:18px;}
    .seg button{flex:1;border:none;cursor:pointer;padding:12px;border-radius:14px;font-size:15px;
      color:var(--muted);background:transparent;transition:.18s ease;}
    .seg button.active{color:var(--text);background:rgba(255,255,255,.13);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);}
    .status{margin-top:12px;display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:18px;
      background:rgba(0,0,0,.18);border:1px solid var(--stroke2);}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--yellow);box-shadow:0 0 0 4px rgba(255,214,10,.14)}
    .dot.ok{background:var(--green);box-shadow:0 0 0 4px rgba(50,215,75,.14)}
    .dot.bad{background:var(--red);box-shadow:0 0 0 4px rgba(255,69,58,.14)}
    .section{margin:12px 10px;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
    label{display:block;margin:2px 10px 8px;font-size:13px;color:var(--muted)}
    input,textarea{width:100%;border-radius:18px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);color:var(--text);padding:14px;font-size:16px;outline:none;}
    .help{margin-top:6px;font-size:12px;color:var(--muted2);padding:0 10px;line-height:1.6}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .btn{flex:1;min-width:170px;cursor:pointer;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.10);color:var(--text);border-radius:18px;padding:14px;font-size:16px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);}
    .btn.primary{background:linear-gradient(180deg, rgba(10,132,255,.95), rgba(10,132,255,.72));
      box-shadow:0 14px 35px rgba(10,132,255,.20);}
    .btn.ghost{background:rgba(0,0,0,.18)}
    .result{margin-top:14px;padding:14px;border-radius:var(--rL);background:var(--glass2);border:1px solid rgba(255,255,255,.14)}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){.kv{grid-template-columns:1fr}}
    .k{font-size:12px;color:var(--muted2);padding:0 4px}
    .v{font-size:16px;margin-top:4px;padding:0 4px;line-height:1.6;white-space:pre-wrap}
    .hidden{display:none !important}
    img.preview{width:100%;border-radius:18px;border:1px solid rgba(255,255,255,.14)}
    .badge{margin-top:12px;display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:18px;background:rgba(0,0,0,.18);border:1px solid var(--stroke2)}

    /* iOS style switch */
    .switchRow{display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border-radius:18px;background:rgba(0,0,0,.18);border:1px solid var(--stroke2);}
    .switchRow .txt{font-size:14px;color:var(--text)}
    .switch{position:relative;width:54px;height:32px;flex:none}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;inset:0;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.16);
      transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:26px;width:26px;right:3px;top:2px;background:white;border-radius:999px;transition:.2s}
    .switch input:checked + .slider{background:rgba(50,215,75,.55)}
    .switch input:checked + .slider:before{transform:translateX(-22px)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</h1>
          <div class="sub">Ø­ÙØ¸ â€¢ Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</div>
        </div>
      </div>
      <!-- Ø²Ø± Ø±Ù‚Ù… (6): Ø²Ø± Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© -->
<button class="pillbtn" id="resetBtn" type="button">Ø¥Ø¹Ø§Ø¯Ø©</button>
    </div>

    <div class="card hero">
      <h2 id="pageTitle">Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</h2>
      <p id="pageDesc">Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø©.</p>

      <!-- Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© Ø«Ø§Ø¨ØªØ© -->
      <div class="result" id="welcomeBanner">
        <div class="k">ğŸ‰ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ©</div>
        <div class="v" style="line-height:1.75;margin-top:6px">
          Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø´Ø±Ø§Ø¡ <b>Ø¬Ù‡Ø§Ø² Ø£ØµÙ„ÙŠ</b> ÙˆØ¨Ù€ <b>Ø¶Ù…Ø§Ù† Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù…Ø¯Ø© Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©</b> âœ…
          <br/>Ù…Ù† <b>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</b> â€” Ù…Ù…ÙŠØ²Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆØ®Ø¯Ù…Ø© Ù…ØªØ§Ø¨Ø¹Ø©.
        </div>
      </div>

      <div class="seg" role="tablist">
        <button id="goSearch" class="active" type="button">Ø¨Ø­Ø«</button>
        <!-- Ø²Ø± Ø±Ù‚Ù… (1): Ø²Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
<button id="goActivate" type="button">Ø¥Ø¹Ø¯Ø§Ø¯</button>
      </div>

      <div class="status">
        <span class="dot" id="statusDot"></span>
        <span id="cloudStatus" style="color:var(--muted)">... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
      </div>

      <div class="result" id="errBox" style="display:none;direction:ltr;text-align:left;white-space:pre-wrap"></div>
    </div>

    <!-- Search -->
    <div class="card section" id="searchCard">
      <div class="grid">
        <div>
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
          <input id="searchName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" />
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="searchPhone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" inputmode="tel" />
        </div>
      </div>

      <div class="row">
        <!-- Ø²Ø± Ø±Ù‚Ù… (3): Ø²Ø± Ø§Ù„Ø¨Ø­Ø« -->
<button class="btn primary" id="searchBtn" type="button">Ø¨Ø­Ø«</button>
        <!-- Ø²Ø± Ø±Ù‚Ù… (4): Ø²Ø± Ø§Ù„Ù…Ø³Ø­ -->
<button class="btn" id="searchClearBtn" type="button">Ù…Ø³Ø­</button>
      </div>

      <div class="result hidden" id="searchResult">
        <div class="kv">
          <div><div class="k">Ø§Ù„Ø§Ø³Ù…</div><div class="v" id="rName">-</div></div>
          <div><div class="k">Ø§Ù„Ù‡Ø§ØªÙ</div><div class="v" id="rPhone">-</div></div>
          <div style="grid-column:1/-1"><div class="k">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</div><div class="v" id="rEnd">-</div></div>
          <div><div class="k">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø£ÙŠØ§Ù…)</div><div class="v" id="rDaysLeft">-</div></div>
          <div><div class="k">Ø§Ù„Ø¹Ø¯Ù‘ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ</div><div class="v" id="rCountdown">-</div></div>

          <div style="grid-column:1/-1"><div class="k">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</div><div class="v" id="rCount">-</div></div>
          <div style="grid-column:1/-1" id="rHistoryWrap" class="hidden">
            <div class="k">Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)</div>
            <div class="v" id="rHistory" style="display:grid;gap:12px"></div>
          </div>
        </div>
        <div class="badge">
          <span class="dot" id="searchDot"></span>
          <span id="searchStatusText">-</span>
        </div>
      </div>
    </div>

    <!-- Activate -->
    <div class="card section hidden" id="activateCard">
      <div class="switchRow">
        <div class="txt">Ø²Ø¨ÙˆÙ† Ø³Ø§Ø¨Ù‚ (Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©)</div>
        <label class="switch">
          <input id="isPrevCustomer" type="checkbox" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="help">Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø¨ÙˆÙ† Ù…Ø´ØªØ±ÙŠ Ø³Ø§Ø¨Ù‚Ø§Ù‹ ÙˆØªØ±ÙŠØ¯ ØªØ¶ÙŠÙÙ‡ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©ØŒ ÙØ¹Ù‘Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ø«Ù… Ø§Ø¶ØºØ· ØªÙØ¹ÙŠÙ„.</div>

      <div class="grid" style="margin-top:12px">
        <div>
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
          <input id="fullName" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ±Ø§Ø± Ù†Ø¨ÙŠÙ„ Ø£ÙƒØ±Ù…" />
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="phone" placeholder="0772xxxxxxx Ø£Ùˆ 9647xxxxxxxxx" inputmode="tel" />
        </div>

        <div style="grid-column:1/-1">
          <label>ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
          <input id="imgFromCamera" type="file" accept="image/*" capture="environment" class="hidden" />
          <input id="imgFromGallery" type="file" accept="image/*" class="hidden" />
          <div class="row" style="margin-top:0">
            <button class="btn primary" id="btnCamera" type="button">ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
            <button class="btn ghost" id="btnGallery" type="button">ğŸ–¼ï¸ Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
          </div>
          <div class="help">Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ â€” ØªÙ†Ø­ÙØ¸ ÙˆØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ø¨Ø­Ø«.</div>
          <div class="result hidden" id="imgPreviewBox" style="margin-top:10px">
            <div class="k">Ù…Ø¹Ø§ÙŠÙ†Ø©</div>
            <div class="v"><img id="imgPreview" class="preview" /></div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Ø²Ø± Ø±Ù‚Ù… (2): Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ -->
<button class="btn primary" id="activateBtn" type="button">Ø­ÙØ¸ 1</button>
        <!-- Ø²Ø± Ø±Ù‚Ù… (5): Ø²Ø± Ø§Ù„Ù†Ø³Ø® -->
<button class="btn" id="copyBtn" type="button">Ù†Ø³Ø®</button>
      </div>

      <div class="result hidden" id="resultBox">
        <div class="kv">
          <div><div class="k">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¶Ù…Ø§Ù†</div><div class="v" id="startDate">-</div></div>
          <div><div class="k">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</div><div class="v" id="endDate">-</div></div>
        </div>
      </div>

      <div class="help" style="margin-top:12px">Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©: <b>9647722806645</b></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {"apiKey": "AIzaSyBMZbRFRU5-GyAmEwLHDspnY6PkEcaz6Ak", "authDomain": "albaman-f8a20.firebaseapp.com", "projectId": "albaman-f8a20", "storageBucket": "albaman-f8a20.firebasestorage.app", "messagingSenderId": "770267943286", "appId": "1:770267943286:web:e3da1c43d65740d7b52a57", "measurementId": "G-CB2PYMZSZT"};
    const HELP_PHONE = "9647722806645";
    const WARRANTY_DAYS = 365;

    const $ = (id)=>document.getElementById(id);

    function setConn(state, msg){
      const dot = $("statusDot");
      dot.className = "dot" + (state==="ok" ? " ok" : state==="bad" ? " bad" : "");
      $("cloudStatus").textContent = msg;
    }
    function showErr(msg){
      const el = $("errBox");
      if(!msg){ el.style.display="none"; el.textContent=""; return; }
      el.style.display="block"; el.textContent = String(msg);
    }
    function normalizeDigits(str){
      return (str||"")
        .replace(/[Ù -Ù©]/g, d => String("Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d)))
        .replace(/[Û°-Û¹]/g, d => String("Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)));
    }
    function sanitizePhone(p){ return normalizeDigits((p||"").trim().replace(/\s+/g,"")); }
    function normalizeName(n){ return (n||"").trim().replace(/\s+/g," "); }

    function fmt(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const da=String(d.getDate()).padStart(2,"0");
      const hh=String(d.getHours()).padStart(2,"0");
      const mm=String(d.getMinutes()).padStart(2,"0");
      return `${y}-${m}-${da} ${hh}:${mm}`;
    }

    function showSearch(){
      $("searchCard").classList.remove("hidden");
      $("activateCard").classList.add("hidden");
      $("goSearch").classList.add("active");
      $("goActivate").classList.remove("active");
      $("pageTitle").textContent="Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†";
      $("pageDesc").textContent="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø©.";
      window.scrollTo({top:0, behavior:"smooth"});
    }
    function showActivate(){
      const pass = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² ÙØªØ­ ØµÙØ­Ø© Ø­ÙØ¸:");
      if(pass !== "878705"){
        alert("Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­");
        showSearch();
        return;
      }
      $("activateCard").classList.remove("hidden");
      $("searchCard").classList.add("hidden");
      $("goActivate").classList.add("active");
      $("goSearch").classList.remove("active");
      $("pageTitle").textContent="Ø­ÙØ¸";
      $("pageDesc").textContent="Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ + Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ + ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©.";
      window.scrollTo({top:0, behavior:"smooth"});
    }

    $("goSearch").addEventListener("click", showSearch);
    $("goActivate").addEventListener("click", showActivate);

    $("resetBtn").addEventListener("click", ()=>{
      ["fullName","phone","searchName","searchPhone"].forEach(id=>{ const el=$(id); if(el) el.value=""; });
      $("searchResult").classList.add("hidden");
      $("resultBox").classList.add("hidden");
      if(window.__countdownTimer) { try{ clearInterval(window.__countdownTimer);}catch(_){ } }
      $("imgPreviewBox").classList.add("hidden");
      window.__invoiceImageData = null;
      $("isPrevCustomer").checked = false;
      showSearch();
    });

    $("searchClearBtn").addEventListener("click", ()=>{
      $("searchName").value=""; $("searchPhone").value="";
      $("searchResult").classList.add("hidden");
    });

    // ---- Image (camera or gallery) -> Base64 + preview ----
    window.__invoiceImageData = null;

    async function fileToCompressedDataURL(file, maxSide=1600, quality=0.78){
      const img = new Image();
      const url = URL.createObjectURL(file);
      await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; img.src=url; });
      const w = img.naturalWidth, h = img.naturalHeight;
      const scale = Math.min(1, maxSide / Math.max(w,h));
      const nw = Math.round(w*scale), nh = Math.round(h*scale);
      const canvas = document.createElement("canvas");
      canvas.width=nw; canvas.height=nh;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img,0,0,nw,nh);
      URL.revokeObjectURL(url);
      return canvas.toDataURL("image/jpeg", quality);
    }

    async function handlePickedFile(file){
      if(!file) return;
      try{
        const dataUrl = await fileToCompressedDataURL(file);
        window.__invoiceImageData = dataUrl;
        $("imgPreview").src = dataUrl;
        $("imgPreviewBox").classList.remove("hidden");
      }catch(err){
        alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©");
        console.log(err);
      }
    }

    $("btnCamera").addEventListener("click", ()=> $("imgFromCamera").click());
    $("btnGallery").addEventListener("click", ()=> $("imgFromGallery").click());
    $("imgFromCamera").addEventListener("change", (e)=> handlePickedFile(e.target.files && e.target.files[0]));
    $("imgFromGallery").addEventListener("change", (e)=> handlePickedFile(e.target.files && e.target.files[0]));

    // ---- Firestore ----
    let db = null;
    try{
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    }catch(e){
      setConn("bad","âŒ Ø®Ø·Ø£ Ø¨ØªÙ‡ÙŠØ¦Ø© Firebase");
      showErr(e?.message || e);
    }

    async function ping(){
      if(!db) return;
      try{
        await db.collection("_health").doc("ping").get();
        setConn("ok","âœ… Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firestore)");
        showErr("");
      }catch(e){
        setConn("bad","âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        showErr((e?.code?e.code:"error")+": "+(e?.message||e));
      }
    }
    setConn("warn","... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    ping();

    async function sha256hex(s){
      const enc = new TextEncoder().encode(s);
      const hash = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    async function customerId(name, phone){
      return sha256hex(normalizeName(name).toLowerCase() + "|" + sanitizePhone(phone));
    }

    function formatEnd(endISO){
      const end = new Date(endISO);
      return fmt(end);
    }

    // ---- Countdown for search result ----
    let __countdownTimer = null;
    function pad2(n){ return String(n).padStart(2,"0"); }
    function startWarrantyCountdown(endDate){
      if(__countdownTimer) clearInterval(__countdownTimer);
      const daysEl = $("rDaysLeft");
      const cdEl = $("rCountdown");

      function tick(){
        const now = new Date();
        const diff = endDate - now;
        if(diff <= 0){
          daysEl.textContent = "0";
          cdEl.textContent = "Ø§Ù†ØªÙ‡Ù‰";
          $("searchDot").className = "dot bad";
          $("searchStatusText").textContent = "ğŸ”´ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¶Ù…Ø§Ù†";
          if(__countdownTimer){ clearInterval(__countdownTimer); __countdownTimer = null; }
          return;
        }
        const totalSec = Math.floor(diff/1000);
        const days = Math.floor(totalSec/86400);
        const hrs = Math.floor((totalSec%86400)/3600);
        const mins = Math.floor((totalSec%3600)/60);
        const secs = totalSec%60;

        daysEl.textContent = String(days);
        cdEl.textContent = `${days} ÙŠÙˆÙ… â€¢ ${pad2(hrs)}:${pad2(mins)}:${pad2(secs)}`;
      }
      tick();
      __countdownTimer = setInterval(tick, 1000);
    }

    function renderHistory(purchases){
      const wrap = $("rHistoryWrap");
      const box = $("rHistory");
      if(!purchases || !Array.isArray(purchases) || purchases.length === 0){
        wrap.classList.add("hidden");
        box.innerHTML = "";
        return;
      }
      // sort newest first by startISO
      const list = purchases
        .filter(p=>p && p.startISO && p.endISO)
        .slice()
        .sort((a,b)=> (new Date(b.startISO)) - (new Date(a.startISO)));

      wrap.classList.remove("hidden");
      box.innerHTML = list.map((p, i)=>{
        const s = p.startISO ? fmt(new Date(p.startISO)) : "-";
        const e = p.endISO ? fmt(new Date(p.endISO)) : "-";
        const img = p.invoiceImage ? `<img class="preview" alt="invoice ${i+1}" src="${p.invoiceImage}"/>` : "";
        return `
          <div class="result" style="margin-top:0">
            <div class="k">ÙØ§ØªÙˆØ±Ø© #${i+1}</div>
            <div class="v" style="margin-top:8px">
              <div style="display:grid;gap:6px">
                <div><span style="color:var(--muted2);font-size:12px">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¶Ù…Ø§Ù†:</span> ${s}</div>
                <div><span style="color:var(--muted2);font-size:12px">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†:</span> ${e}</div>
              </div>
              ${img ? `<div style="margin-top:10px">${img}</div>` : ``}
            </div>
          </div>
        `;
      }).join("");
    }

    $("activateBtn").addEventListener("click", async ()=>{
const fullName = normalizeName($("fullName").value);
      const phone = sanitizePhone($("phone").value);
      const img = window.__invoiceImageData;
      const isPrev = $("isPrevCustomer").checked;

      if(fullName.split(" ").length < 3) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ (3 ÙƒÙ„Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).");
      if(phone.length < 8) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­.");
      if(!img) return alert("ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ø²Ø§Ù…ÙŠØ© (Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ).");
      if(!db) return alert("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");

      try{
        const id = await customerId(fullName, phone);
        const ref = db.collection("customers").doc(id);
        const snap = await ref.get();

        if(snap.exists && !isPrev){
          alert("Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ† Ù…Ø´ØªØ±ÙŠ Ø³Ø§Ø¨Ù‚Ø§Ù‹ âœ…\nÙØ¹Ù‘Ù„ Ø²Ø± (Ø²Ø¨ÙˆÙ† Ø³Ø§Ø¨Ù‚) Ø­ØªÙ‰ ØªÚ¯Ø¯Ø± ØªØ¶ÙŠÙÙ‡ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.");
          return;
        }

        const now = new Date();
        const end = new Date(now);
        end.setDate(end.getDate() + WARRANTY_DAYS);

        const prevCount = snap.exists ? (snap.data().purchaseCount || 1) : 0;
        const newCount = snap.exists ? (prevCount + 1) : 1;

        
        const purchaseObj = {
          startISO: now.toISOString(),
          endISO: end.toISOString(),
          invoiceImage: img,
          createdAtISO: now.toISOString()
        };

        await ref.set({
          fullName,
          phone,
          // Ø¢Ø®Ø± Ø´Ø±Ø§Ø¡ (Ù„Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹)
          startISO: purchaseObj.startISO,
          endISO: purchaseObj.endISO,
          invoiceImage: purchaseObj.invoiceImage,
          // Ø³Ø¬Ù„ ÙƒÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª/Ø§Ù„ÙÙˆØ§ØªÙŠØ±
          purchases: snap.exists
            ? firebase.firestore.FieldValue.arrayUnion(purchaseObj)
            : [purchaseObj],
          purchaseCount: newCount,
          lastPurchaseAt: firebase.firestore.FieldValue.serverTimestamp(),
          isPrevCustomer: !!snap.exists,
        }, { merge:true });
$("resultBox").classList.remove("hidden");
        $("startDate").textContent = fmt(now);
        $("endDate").textContent = fmt(end);

        alert("ØªÙ… Ø­ÙØ¸ âœ…");
      }catch(e){
        alert("Ø®Ø·Ø£: " + (e?.message || e));
        console.log(e);
      }
    });

    $("searchBtn").addEventListener("click", async ()=>{
      const name = normalizeName($("searchName").value);
      const phone = sanitizePhone($("searchPhone").value);

      if(name.split(" ").length < 3) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ.");
      if(phone.length < 8) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.");
      if(!db) return alert("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");

      try{
        const id = await customerId(name, phone);
        const snap = await db.collection("customers").doc(id).get();
        if(!snap.exists){
          $("searchResult").classList.add("hidden");
          alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù….");
          return;
        }
        const d = snap.data() || {};

        $("rName").textContent = d.fullName || "-";
        $("rPhone").textContent = d.phone || "-";
        
        // Ø§Ø¹Ø±Ø¶ Ø¢Ø®Ø± ÙØªØ±Ø© Ø¶Ù…Ø§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ (Ø¥Ù† ÙˆØ¬Ø¯Øª)
        const purchases = Array.isArray(d.purchases) ? d.purchases : [];
        // ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±)
        if(purchases.length === 0 && (d.invoiceImage || d.startISO || d.endISO)){
          purchases.push({
            startISO: d.startISO || null,
            endISO: d.endISO || null,
            invoiceImage: d.invoiceImage || null,
            createdAtISO: null
          });
        }
        const latest = purchases.length
          ? purchases
              .filter(p=>p && p.endISO)
              .slice()
              .sort((a,b)=> (new Date(b.startISO||0)) - (new Date(a.startISO||0)))[0]
          : null;

        const endISO = (latest && latest.endISO) ? latest.endISO : d.endISO;
        $("rEnd").textContent = endISO ? formatEnd(endISO) : "-";

        const count = purchases.length ? purchases.length : (d.purchaseCount || 1);
        $("rCount").textContent = count + " Ù…Ø±Ø©";

        // Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© + Ø§Ù„ØµÙˆØ±
        renderHistory(purchases);

        // Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ù…Ø§Ù† + Ø§Ù„Ø¹Ø¯Ù‘ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
        const end = endISO ? new Date(endISO) : null;
        const active = end ? (new Date() <= end) : false;
        $("searchDot").className = active ? "dot ok" : "dot bad";
        $("searchStatusText").textContent = active ? "ğŸŸ¢ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù†" : "ğŸ”´ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¶Ù…Ø§Ù†";

        if(end) startWarrantyCountdown(end);


        $("searchResult").classList.remove("hidden");
        $("searchResult").scrollIntoView({behavior:"smooth", block:"start"});
      }catch(e){
        alert("Ø®Ø·Ø£: " + (e?.message || e));
        console.log(e);
      }
    });

    $("copyBtn").addEventListener("click", async ()=>{
      const t =
        "Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©\n" +
        "Ø§Ù„Ø§Ø³Ù…: " + ($("fullName").value||"") + "\n" +
        "Ø§Ù„Ù‡Ø§ØªÙ: " + ($("phone").value||"") + "\n" +
        "Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†: " + ($("endDate").textContent||"");
      try{ await navigator.clipboard.writeText(t); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“"); }
      catch(_ ){ alert(t); }
    });

    showSearch();
  </script>
</body>
</html>
