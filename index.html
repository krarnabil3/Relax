<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</title>
  <meta name="theme-color" content="#061724" />
  <style>

    
    
    :root{
      /* Premium joyful palette */
      --bg0:#FFFDF8;
      --bg1:#FFF6F0;
      --bg2:#F1F6FF;

      --glass: rgba(255,255,255,.78);
      --glass2: rgba(255,255,255,.58);
      --stroke: rgba(20,28,46,.10);
      --stroke2: rgba(20,28,46,.08);

      --text: rgba(20,28,46,.90);
      --muted: rgba(20,28,46,.60);
      --muted2: rgba(20,28,46,.44);

      /* Accents */
      --blue:#0A84FF;
      --mint:#34C759;
      --gold:#FFCC00;
      --pink:#FF2D55;
      --purple:#AF52DE;
      --orange:#FF9500;

      --shadow: 0 24px 60px rgba(18,20,30,.14);
      --shadow2: 0 14px 36px rgba(18,20,30,.16);
      --blur: 24px;

      --rXL: 30px;
      --rL: 22px;
      --rM: 18px;
      --rS: 14px;
    }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display","SF Pro Text","Segoe UI", Arial;
      color:var(--text);
      background:
        radial-gradient(900px 650px at 12% -10%, rgba(175,82,222,.18), transparent 62%),
        radial-gradient(900px 650px at 110% 0%, rgba(10,132,255,.16), transparent 62%),
        radial-gradient(900px 650px at 50% 115%, rgba(52,199,89,.14), transparent 60%),
        radial-gradient(700px 520px at 0% 90%, rgba(255,149,0,.14), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg1) 42%, var(--bg0));
      -webkit-font-smoothing: antialiased;
      overflow-x:hidden;
    }

    body:before{
      content:"";
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.055'/%3E%3C/svg%3E");
      opacity:.35;
      pointer-events:none;
      mix-blend-mode: multiply;
    }
body:before{
      content:"";
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.06'/%3E%3C/svg%3E");
      opacity:.35;
      pointer-events:none;
      mix-blend-mode: multiply;
    }
*{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display","SF Pro Text","Segoe UI", Arial;
      color:var(--text);
      background:
        radial-gradient(1000px 700px at 16% -10%, rgba(10,132,255,.22), transparent 60%),
        radial-gradient(900px 650px at 110% 0%, rgba(50,215,75,.12), transparent 60%),
        radial-gradient(700px 500px at 55% 105%, rgba(255,214,10,.08), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1) 40%, var(--bg0));
      -webkit-font-smoothing: antialiased;
      overflow-x:hidden;
    }

    /* subtle luxury grain */
    body:before{
      content:"";
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.12'/%3E%3C/svg%3E");
      opacity:.12;
      pointer-events:none;
      mix-blend-mode: overlay;
    }

    .wrap{max-width:980px;margin:0 auto;padding:max(18px,env(safe-area-inset-top)) 14px 84px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 10px 0}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}

    .logo{
      width:46px;height:46px;border-radius:18px;flex:none;
      background:
        radial-gradient(circle at 30% 20%, rgba(175,82,222,.95), rgba(10,132,255,.10)),
        radial-gradient(circle at 80% 80%, rgba(50,215,75,.55), rgba(50,215,75,.05)),
        radial-gradient(circle at 40% 90%, rgba(255,149,0,.30), rgba(255,214,10,0));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.18), 0 18px 42px rgba(0,0,0,.42);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), transparent 55%);
      transform: rotate(10deg);
    }

    .title h1{margin:0;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:.2px}
    .title .sub{margin-top:4px;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* premium glass surfaces */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      border-radius:var(--rXL);
      box-shadow:var(--shadow);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(circle at 20% 10%, rgba(255,255,255,.10), transparent 40%);
      pointer-events:none;
    }

    .hero{margin:12px 10px 14px;padding:18px}
    .hero h2{margin:0;font-size:22px;letter-spacing:.2px}
    .hero p{margin:8px 0 0;line-height:1.7;color:var(--muted)}

    .section{margin:12px 10px;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}

    label{display:block;margin:2px 10px 8px;font-size:12px;color:var(--muted);letter-spacing:.2px}

    input,textarea{
      width:100%;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:var(--text);
      padding:14px 14px;
      font-size:16px;
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
      transition: border-color .16s ease, box-shadow .16s ease, transform .10s ease;
    }
    input:focus, textarea:focus{
      border-color: rgba(10,132,255,.55);
      box-shadow: 0 0 0 4px rgba(10,132,255,.14), inset 0 1px 0 rgba(255,255,255,.10);
    }

    .help{margin-top:7px;font-size:12px;color:var(--muted2);padding:0 10px;line-height:1.7}

    /* Segmented control â€“ luxe */
    .seg{
      margin-top:14px;
      display:flex;
      gap:8px;
      padding:7px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius:20px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    .seg button{
      flex:1;
      border:none;
      cursor:pointer;
      padding:12px 14px;
      border-radius:16px;
      font-size:14px;
      color:var(--muted);
      background: transparent;
      transition:.18s ease;
      position:relative;
      overflow:hidden;
    }
    .seg button.active{
      color:var(--text);
      background: rgba(255,255,255,.10);
      box-shadow:
        0 10px 26px rgba(0,0,0,.22),
        inset 0 1px 0 rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.12);
    }

    /* iOS glass buttons */
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    @media (max-width:760px){.row{flex-direction:column}.btn{min-width:unset}}

    .btn, .pillbtn{
      position:relative;
      overflow:hidden;
      cursor:pointer;
      border-radius:20px;
      padding:14px;
      font-size:16px;
      color:var(--text);
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      box-shadow: var(--shadow2), inset 0 1px 0 rgba(255,255,255,.18), inset 0 -1px 0 rgba(0,0,0,.20);
      transition: transform .12s ease, filter .12s ease, background .18s ease;
    }
    .btn{flex:1;min-width:170px}
    .pillbtn{padding:10px 14px;border-radius:999px;font-size:14px}

    .btn::before, .pillbtn::before{
      content:"";
      position:absolute;
      inset:-35%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.22), transparent 55%);
      transform: rotate(8deg);
      pointer-events:none;
    }
    .btn::after, .pillbtn::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.14) 18%, transparent 36%);
      transform: translateX(-140%);
      pointer-events:none;
    }
    .btn:hover::after, .pillbtn:hover::after{ animation: shine 1.15s ease; }
    @keyframes shine{ from{transform:translateX(-140%)} to{transform:translateX(140%)} }
    .btn:active, .pillbtn:active{ transform: scale(.985); filter: brightness(.98); }

    .btn.primary{
      border:1px solid rgba(120,195,255,.32);
      background: linear-gradient(135deg, rgba(10,132,255,.62), rgba(175,82,222,.46), rgba(255,149,0,.32));
      box-shadow: 0 18px 46px rgba(10,132,255,.18), var(--shadow2), inset 0 1px 0 rgba(255,255,255,.18);
    }
    .btn.ghost{ background: rgba(0,0,0,.24); }

    /* status bar */
    .status{
      margin-top:12px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-radius:20px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--gold);box-shadow:0 0 0 4px rgba(255,149,0,.14)}
    .dot.ok{background:var(--mint);box-shadow:0 0 0 4px rgba(50,215,75,.14)}
    .dot.bad{background:var(--red);box-shadow:0 0 0 4px rgba(255,69,58,.14)}

    .result{
      margin-top:14px;
      padding:14px;
      border-radius:var(--rL);
      background: var(--glass2);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
    }
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){.kv{grid-template-columns:1fr}}
    .k{font-size:12px;color:var(--muted2);padding:0 4px}
    .v{font-size:16px;margin-top:4px;padding:0 4px;line-height:1.7;white-space:pre-wrap}
    .hidden{display:none !important}
    img.preview{width:100%;border-radius:18px;border:1px solid rgba(255,255,255,.12)}

    .badge{margin-top:12px;display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:20px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.10)}

    /* iOS switch */
    .switchRow{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border-radius:20px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.10);
    }
    .switchRow .txt{font-size:14px;color:var(--text)}
    .switch{position:relative;width:54px;height:32px;flex:none}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;inset:0;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.16);
      transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:26px;width:26px;right:3px;top:2px;background:white;border-radius:999px;transition:.2s}
    .switch input:checked + .slider{background:rgba(50,215,75,.55)}
    .switch input:checked + .slider:before{transform:translateX(-22px)}

    /* Motion welcome */
    .welcomeMotion{
      position:relative;
      border-radius:22px;
      overflow:hidden;
      padding:16px 14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 52px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.16);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      min-height:128px;
    }
    .wmBg{position:absolute;inset:0;pointer-events:none}
    .blob{position:absolute;width:190px;height:190px;border-radius:999px;filter: blur(18px);opacity:.75;mix-blend-mode: screen;animation: floaty 7.5s ease-in-out infinite;}
    .blob.b1{right:-70px; top:-70px; background: radial-gradient(circle at 30% 30%, rgba(10,132,255,.95), rgba(10,132,255,0));}
    .blob.b2{left:-80px; bottom:-80px; background: radial-gradient(circle at 30% 30%, rgba(50,215,75,.70), rgba(50,215,75,0)); animation-duration: 8.6s;}
    .blob.b3{right:40px; bottom:-95px; background: radial-gradient(circle at 30% 30%, rgba(255,214,10,.55), rgba(255,214,10,0)); animation-duration: 9.4s;}
    @keyframes floaty{0%,100%{transform:translate3d(0,0,0) scale(1)}50%{transform:translate3d(-18px,14px,0) scale(1.05)}}
    .spark{position:absolute;width:8px;height:8px;border-radius:999px;background: rgba(255,255,255,.85);box-shadow: 0 0 0 6px rgba(255,255,255,.08);opacity:0;animation:sparkle 2.9s ease-in-out infinite;}
    .spark.s1{left:18px; top:18px;}
    .spark.s2{left:54%; top:22px; animation-delay:.7s}
    .spark.s3{right:28px; bottom:22px; animation-delay:1.2s}
    @keyframes sparkle{0%,70%,100%{transform:scale(.6);opacity:0}78%{opacity:.85;transform:scale(1)}86%{opacity:.25;transform:scale(1.2)}}
    .wmText{position:relative; z-index:1}
    .wmBadge{display:inline-flex;align-items:center;gap:8px;padding:7px 12px;border-radius:999px;background: rgba(0,0,0,.24);border:1px solid rgba(255,255,255,.14);font-size:12px;color:var(--text);box-shadow: inset 0 1px 0 rgba(255,255,255,.14);}
    .wmTitle{margin-top:10px;font-size:16px;font-weight:800;letter-spacing:.2px}
    .wmDesc{margin-top:6px;color:var(--muted);line-height:1.75;font-size:13px}

    /* Warranty box already in file; keep compatible */
    .warrantyBox{border-radius:22px;background: rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);box-shadow: 0 16px 44px rgba(0,0,0,.26);backdrop-filter: blur(24px);-webkit-backdrop-filter: blur(24px);}
    .wBar{background: rgba(0,0,0,.26);border:1px solid rgba(255,255,255,.10)}
    .wFill{background: linear-gradient(90deg, rgba(52,199,89,.85), rgba(10,132,255,.85), rgba(175,82,222,.70));}

  
    /* ===== Big Joyful Welcome ===== */
    .bigWelcome{
      padding:22px 18px;
      min-height:180px;
    }
    .bigWelcome .wmBadge{
      font-size:13px;
      padding:8px 14px;
      background: rgba(255,149,0,.14);
      border-color: rgba(255,149,0,.30);
    }
    .wmHeadline{
      margin-top:12px;
      font-size:22px;
      font-weight:900;
      letter-spacing:.3px;
      line-height:1.2;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .dotSep{color:rgba(255,255,255,.55); font-weight:800}
    .grad, .grad2, .grad3{
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      display:inline-block;
    }
    .grad{background-image: linear-gradient(90deg, rgba(10,132,255,1), rgba(120,195,255,1));}
    .grad2{background-image: linear-gradient(90deg, rgba(50,215,75,1), rgba(180,255,210,1));}
    .grad3{background-image: linear-gradient(90deg, rgba(255,214,10,1), rgba(255,240,180,1));}

    .bigWelcome .wmTitle{
      margin-top:8px;
      font-size:17px;
      font-weight:800;
    }
    .bigWelcome .wmDesc{
      font-size:14px;
      color:rgba(255,255,255,.74);
    }

    /* Confetti pieces */
    .cf{
      position:absolute;
      width:10px;height:10px;
      border-radius:3px;
      opacity:.0;
      transform: translateY(-12px) rotate(0deg);
      animation: confetti 3.8s ease-in-out infinite;
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
    }
    .c1{left:12px; top:18px; background: rgba(255,214,10,.95); animation-delay:.1s}
    .c2{left:36px; top:44px; background: rgba(10,132,255,.95); animation-delay:.45s}
    .c3{left:64%; top:16px; background: rgba(50,215,75,.95); animation-delay:.75s}
    .c4{right:18px; top:40px; background: rgba(255,69,58,.95); animation-delay:1.05s}
    .c5{right:62px; top:16px; background: rgba(180,255,210,.95); animation-delay:1.35s}
    .c6{left:18px; bottom:30px; background: rgba(120,195,255,.95); animation-delay:1.65s}
    .c7{right:18px; bottom:26px; background: rgba(255,240,180,.95); animation-delay:1.95s}
    .c8{left:54%; bottom:26px; background: rgba(255,214,10,.95); animation-delay:2.25s}

    @keyframes confetti{
      0%, 68%, 100%{ opacity:0; transform: translateY(-12px) rotate(0deg) }
      72%{ opacity:.95; transform: translateY(0px) rotate(30deg) }
      86%{ opacity:.75; transform: translateY(10px) rotate(120deg) }
      94%{ opacity:0; transform: translateY(18px) rotate(180deg) }
    }

    /* Nice entrance animation */
    .bigWelcome{ animation: popIn .55s ease both; }
    @keyframes popIn{
      from{ transform: translateY(10px) scale(.985); opacity:0; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }

    @media (max-width:480px){
      .wmHeadline{font-size:19px}
      .bigWelcome{min-height:190px}
    }


    /* ===== Refined Spacing & Typography (Apple-like) ===== */
    body{
      font-size:15px;
      line-height:1.6;
    }

    .wrap{
      max-width:920px;
      padding:22px 16px 90px;
    }

    .top{
      padding:14px 8px 4px;
    }

    .logo{
      width:42px;
      height:42px;
      border-radius:16px;
    }

    .title h1{
      font-size:17px;
      font-weight:700;
      letter-spacing:.15px;
    }
    .title .sub{
      font-size:12px;
    }

    .hero{
      padding:22px 18px;
    }
    .hero h2{
      font-size:20px;
      font-weight:800;
    }
    .hero p{
      font-size:14px;
    }

    .section{
      padding:18px;
    }

    label{
      font-size:12px;
      margin-bottom:6px;
    }

    input, textarea{
      font-size:15px;
      padding:13px 14px;
      border-radius:18px;
    }

    .btn{
      font-size:15px;
      padding:13px;
      border-radius:18px;
    }
    .btn.primary{
      font-weight:600;
    }
    .pillbtn{
      font-size:13px;
      padding:9px 13px;
    }

    .seg{
      gap:6px;
      padding:6px;
    }
    .seg button{
      font-size:14px;
      padding:11px;
    }

    .welcomeMotion{
      padding:24px 20px;
    }

    .wmHeadline{
      font-size:21px;
    }
    .wmTitle{
      font-size:16px;
    }
    .wmDesc{
      font-size:13.5px;
    }

    .warrantyBox{
      padding:18px;
    }
    .wBig{
      font-size:30px;
    }
    .wBig small{
      font-size:13px;
    }

    .reportBtn{
      font-size:15px;
      padding:13px;
    }

    .result{
      padding:14px;
    }

</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</h1>
          <div class="sub">Ø­ÙØ¸ â€¢ Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</div>
        </div>
      </div>
      <!-- Ø²Ø± Ø±Ù‚Ù… (6): Ø²Ø± Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© -->
<button class="pillbtn" id="resetBtn" type="button">Ø¥Ø¹Ø§Ø¯Ø©</button>
    </div>

    <div class="card hero">
      <h2 id="pageTitle">Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</h2>
      <p id="pageDesc">Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø©.</p>

      <!-- Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© Ø«Ø§Ø¨ØªØ© -->
      
      
      <div class="result" id="welcomeBanner">
        <div class="welcomeMotion bigWelcome" role="status" aria-label="Welcome">
          <div class="wmBg">
            <span class="blob b1"></span>
            <span class="blob b2"></span>
            <span class="blob b3"></span>

            <span class="spark s1"></span><span class="spark s2"></span><span class="spark s3"></span>

            <!-- confetti -->
            <span class="cf c1"></span><span class="cf c2"></span><span class="cf c3"></span><span class="cf c4"></span>
            <span class="cf c5"></span><span class="cf c6"></span><span class="cf c7"></span><span class="cf c8"></span>
          </div>

          <div class="wmText">
            <div class="wmBadge">ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ</div>

            <div class="wmHeadline">
              <span class="grad">Ø¬Ù‡Ø§Ø² Ø£ØµÙ„ÙŠ</span>
              <span class="dotSep">â€¢</span>
              <span class="grad2">Ø¶Ù…Ø§Ù† Ø­Ù‚ÙŠÙ‚ÙŠ</span>
              <span class="dotSep">â€¢</span>
              <span class="grad3">Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©</span>
            </div>

            <div class="wmTitle">Ø±Ø§Ù‚ÙŠâ€¦ Ù‚ÙˆÙŠâ€¦ ÙˆÙ…Ø¶Ù…ÙˆÙ† âœ…</div>

            <div class="wmDesc">
              Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù€ <b>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</b> â€” Ø®Ø¯Ù…Ø© Ø±Ø§Ù‚ÙŠØ© ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©.
              <br/>ğŸ“ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¶Ù…Ø§Ù†: <b dir="ltr">07722806645</b>
            </div>
          </div>
        </div>
      </div>
<div class="wmText">
            <div class="wmBadge">âœ¨ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§</div>
            <div class="wmTitle">Ø¬Ù‡Ø§Ø² Ø±Ø§Ù‚ÙŠ â€¢ Ø£Ø¯Ø§Ø¡ Ù‚ÙˆÙŠ â€¢ Ø¶Ù…Ø§Ù† Ø­Ù‚ÙŠÙ‚ÙŠ</div>
            <div class="wmDesc">
              Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø´Ø±Ø§Ø¡ <b>Ø¬Ù‡Ø§Ø² Ø£ØµÙ„ÙŠ</b> ÙˆØ¨Ù€ <b>Ø¶Ù…Ø§Ù† Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù…Ø¯Ø© Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©</b> âœ…
              <br/>Ø®Ø¯Ù…Ø© Ø§Ù„Ø¶Ù…Ø§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù…: <b dir="ltr">07722806645</b>
            </div>
          </div>
        </div>
      </div>
<div class="v" style="line-height:1.75;margin-top:6px">
          Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø´Ø±Ø§Ø¡ <b>Ø¬Ù‡Ø§Ø² Ø£ØµÙ„ÙŠ</b> ÙˆØ¨Ù€ <b>Ø¶Ù…Ø§Ù† Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù…Ø¯Ø© Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©</b> âœ…
          <br/>Ù…Ù† <b>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</b> â€” Ù…Ù…ÙŠØ²Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆØ®Ø¯Ù…Ø© Ù…ØªØ§Ø¨Ø¹Ø©.
        </div>
      </div>

      <div class="seg" role="tablist">
        <button id="goSearch" class="active" type="button">Ø¨Ø­Ø«</button>
        <!-- Ø²Ø± Ø±Ù‚Ù… (1): Ø²Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
<button id="goActivate" type="button">Ø¥Ø¹Ø¯Ø§Ø¯</button>
      </div>

      <div class="status">
        <span class="dot" id="statusDot"></span>
        <span id="cloudStatus" style="color:var(--muted)">... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
      </div>

      <div class="result" id="errBox" style="display:none;direction:ltr;text-align:left;white-space:pre-wrap"></div>
    </div>

    <!-- Search -->
    <div class="card section" id="searchCard">
      <div class="grid">
        <div>
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
          <input id="searchName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" />
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="searchPhone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" inputmode="tel" />
        </div>
      </div>

      <div class="row">
        <!-- Ø²Ø± Ø±Ù‚Ù… (3): Ø²Ø± Ø§Ù„Ø¨Ø­Ø« -->
<button class="btn primary" id="searchBtn" type="button">Ø¨Ø­Ø«</button>
        <!-- Ø²Ø± Ø±Ù‚Ù… (4): Ø²Ø± Ø§Ù„Ù…Ø³Ø­ -->
<button class="btn" id="searchClearBtn" type="button">Ù…Ø³Ø­</button>
      </div>

      <div class="result hidden" id="searchResult">
        <div class="kv">
          <div><div class="k">Ø§Ù„Ø§Ø³Ù…</div><div class="v" id="rName">-</div></div>
          <div><div class="k">Ø§Ù„Ù‡Ø§ØªÙ</div><div class="v" id="rPhone">-</div></div>
          <div style="grid-column:1/-1"><div class="k">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</div><div class="v" id="rEnd">-</div></div>
        <div style="grid-column:1/-1">
          <div class="warrantyBox" id="warrantyBox">
            <div class="wTop">
              <div class="wTitle">Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¶Ù…Ø§Ù†</div>
              <div class="wPill" id="wStatusPill">-</div>
            </div>

            <div class="wBig">
              <span id="rDaysLeft">-</span>
              <small>ÙŠÙˆÙ…</small>
              <span style="font-size:16px;color:var(--muted);font-weight:700" id="rCountdown">-</span>
            </div>

            <div class="wSub" id="wSubText">-</div>

            <div class="wBar" aria-label="warranty progress">
              <div class="wFill" id="wFill"></div>
            </div>

            <div class="wMeta">
              <div class="m">
                <div class="k">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¶Ù…Ø§Ù†</div>
                <div class="v" id="rStart">-</div>
              </div>
              <div class="m">
                <div class="k">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</div>
                <div class="v" id="rEnd2">-</div>
              </div>
            </div>

            <button class="reportBtn" id="reportBtn" type="button">ğŸ§¾ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
          </div>
        </div>
    <div style="grid-column:1/-1"><div class="k">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</div><div class="v" id="rCount">-</div></div>
          <div style="grid-column:1/-1" id="rHistoryWrap" class="hidden">
            <div class="k">Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)</div>
            <div class="v" id="rHistory" style="display:grid;gap:12px"></div>
          </div>
        </div>
        <div class="badge">
          <span class="dot" id="searchDot"></span>
          <span id="searchStatusText">-</span>
        </div>
      </div>
    </div>

    <!-- Activate -->
    <div class="card section hidden" id="activateCard">
      <div class="switchRow">
        <div class="txt">Ø²Ø¨ÙˆÙ† Ø³Ø§Ø¨Ù‚ (Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©)</div>
        <label class="switch">
          <input id="isPrevCustomer" type="checkbox" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="help">Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø¨ÙˆÙ† Ù…Ø´ØªØ±ÙŠ Ø³Ø§Ø¨Ù‚Ø§Ù‹ ÙˆØªØ±ÙŠØ¯ ØªØ¶ÙŠÙÙ‡ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©ØŒ ÙØ¹Ù‘Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ø«Ù… Ø§Ø¶ØºØ· ØªÙØ¹ÙŠÙ„.</div>

      <div class="grid" style="margin-top:12px">
        <div>
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
          <input id="fullName" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ±Ø§Ø± Ù†Ø¨ÙŠÙ„ Ø£ÙƒØ±Ù…" />
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="phone" placeholder="0772xxxxxxx Ø£Ùˆ 9647xxxxxxxxx" inputmode="tel" />
        </div>

        <div style="grid-column:1/-1">
          <label>ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
          <input id="imgFromCamera" type="file" accept="image/*" capture="environment" class="hidden" />
          <input id="imgFromGallery" type="file" accept="image/*" class="hidden" />
          <div class="row" style="margin-top:0">
            <button class="btn primary" id="btnCamera" type="button">ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
            <button class="btn ghost" id="btnGallery" type="button">ğŸ–¼ï¸ Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
          </div>
          <div class="help">Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ â€” ØªÙ†Ø­ÙØ¸ ÙˆØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ø¨Ø­Ø«.</div>
          <div class="result hidden" id="imgPreviewBox" style="margin-top:10px">
            <div class="k">Ù…Ø¹Ø§ÙŠÙ†Ø©</div>
            <div class="v"><img id="imgPreview" class="preview" /></div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Ø²Ø± Ø±Ù‚Ù… (2): Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ -->
<button class="btn primary" id="activateBtn" type="button">Ø­ÙØ¸ 1</button>
        <!-- Ø²Ø± Ø±Ù‚Ù… (5): Ø²Ø± Ø§Ù„Ù†Ø³Ø® -->
<button class="btn" id="copyBtn" type="button">Ù†Ø³Ø®</button>
      </div>

      <div class="result hidden" id="resultBox">
        <div class="kv">
          <div><div class="k">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¶Ù…Ø§Ù†</div><div class="v" id="startDate">-</div></div>
          <div><div class="k">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</div><div class="v" id="endDate">-</div></div>
        </div>
      </div>

      <div class="help" style="margin-top:12px">Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©: <b>07722806645</b></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {"apiKey": "AIzaSyBMZbRFRU5-GyAmEwLHDspnY6PkEcaz6Ak", "authDomain": "albaman-f8a20.firebaseapp.com", "projectId": "albaman-f8a20", "storageBucket": "albaman-f8a20.firebasestorage.app", "messagingSenderId": "770267943286", "appId": "1:770267943286:web:e3da1c43d65740d7b52a57", "measurementId": "G-CB2PYMZSZT"};
    const HELP_PHONE = "07722806645";
    const WARRANTY_DAYS = 365;

    const $ = (id)=>document.getElementById(id);

    function setConn(state, msg){
      const dot = $("statusDot");
      dot.className = "dot" + (state==="ok" ? " ok" : state==="bad" ? " bad" : "");
      $("cloudStatus").textContent = msg;
    }
    function showErr(msg){
      const el = $("errBox");
      if(!msg){ el.style.display="none"; el.textContent=""; return; }
      el.style.display="block"; el.textContent = String(msg);
    }
    function normalizeDigits(str){
      return (str||"")
        .replace(/[Ù -Ù©]/g, d => String("Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d)))
        .replace(/[Û°-Û¹]/g, d => String("Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)));
    }
    function sanitizePhone(p){ return normalizeDigits((p||"").trim().replace(/\s+/g,"")); }
    function normalizeName(n){ return (n||"").trim().replace(/\s+/g," "); }

    function fmt(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const da=String(d.getDate()).padStart(2,"0");
      const hh=String(d.getHours()).padStart(2,"0");
      const mm=String(d.getMinutes()).padStart(2,"0");
      return `${y}-${m}-${da} ${hh}:${mm}`;
    }

    function showSearch(){
      $("searchCard").classList.remove("hidden");
      $("activateCard").classList.add("hidden");
      $("goSearch").classList.add("active");
      $("goActivate").classList.remove("active");
      $("pageTitle").textContent="Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†";
      $("pageDesc").textContent="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø©.";
      window.scrollTo({top:0, behavior:"smooth"});
    }
    function showActivate(){
      const pass = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² ÙØªØ­ ØµÙØ­Ø© Ø­ÙØ¸:");
      if(pass !== "878705"){
        alert("Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­");
        showSearch();
        return;
      }
      $("activateCard").classList.remove("hidden");
      $("searchCard").classList.add("hidden");
      $("goActivate").classList.add("active");
      $("goSearch").classList.remove("active");
      $("pageTitle").textContent="Ø­ÙØ¸";
      $("pageDesc").textContent="Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ + Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ + ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©.";
      window.scrollTo({top:0, behavior:"smooth"});
    }

    $("goSearch").addEventListener("click", showSearch);
    $("goActivate").addEventListener("click", showActivate);

    $("resetBtn").addEventListener("click", ()=>{
      ["fullName","phone","searchName","searchPhone"].forEach(id=>{ const el=$(id); if(el) el.value=""; });
      $("searchResult").classList.add("hidden");
      $("resultBox").classList.add("hidden");
      if(window.__countdownTimer) { try{ clearInterval(window.__countdownTimer);}catch(_){ } }
      $("imgPreviewBox").classList.add("hidden");
      window.__invoiceImageData = null;
    window.__lastCustomer = null;
      $("isPrevCustomer").checked = false;
      showSearch();
    });

    $("searchClearBtn").addEventListener("click", ()=>{
      $("searchName").value=""; $("searchPhone").value="";
      $("searchResult").classList.add("hidden");
    });

    // ---- Image (camera or gallery) -> Base64 + preview ----
    window.__invoiceImageData = null;
    window.__lastCustomer = null;

    async function fileToCompressedDataURL(file, maxSide=1600, quality=0.78){
      const img = new Image();
      const url = URL.createObjectURL(file);
      await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; img.src=url; });
      const w = img.naturalWidth, h = img.naturalHeight;
      const scale = Math.min(1, maxSide / Math.max(w,h));
      const nw = Math.round(w*scale), nh = Math.round(h*scale);
      const canvas = document.createElement("canvas");
      canvas.width=nw; canvas.height=nh;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img,0,0,nw,nh);
      URL.revokeObjectURL(url);
      return canvas.toDataURL("image/jpeg", quality);
    }

    async function handlePickedFile(file){
      if(!file) return;
      try{
        const dataUrl = await fileToCompressedDataURL(file);
        window.__invoiceImageData = dataUrl;
        $("imgPreview").src = dataUrl;
        $("imgPreviewBox").classList.remove("hidden");
      }catch(err){
        alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©");
        console.log(err);
      }
    }

    $("btnCamera").addEventListener("click", ()=> $("imgFromCamera").click());
    $("btnGallery").addEventListener("click", ()=> $("imgFromGallery").click());
    $("imgFromCamera").addEventListener("change", (e)=> handlePickedFile(e.target.files && e.target.files[0]));
    $("imgFromGallery").addEventListener("change", (e)=> handlePickedFile(e.target.files && e.target.files[0]));

    // ---- Firestore ----
    let db = null;
    try{
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    }catch(e){
      setConn("bad","âŒ Ø®Ø·Ø£ Ø¨ØªÙ‡ÙŠØ¦Ø© Firebase");
      showErr(e?.message || e);
    }

    async function ping(){
      if(!db) return;
      try{
        await db.collection("_health").doc("ping").get();
        setConn("ok","âœ… Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firestore)");
        showErr("");
      }catch(e){
        setConn("bad","âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        showErr((e?.code?e.code:"error")+": "+(e?.message||e));
      }
    }
    setConn("warn","... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    ping();

    async function sha256hex(s){
      const enc = new TextEncoder().encode(s);
      const hash = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    async function customerId(name, phone){
      return sha256hex(normalizeName(name).toLowerCase() + "|" + sanitizePhone(phone));
    }

    function formatEnd(endISO){
      const end = new Date(endISO);
      return fmt(end);
    }

    // ---- Countdown for search result ----
    let __countdownTimer = null;
    function pad2(n){ return String(n).padStart(2,"0"); }
    function startWarrantyCountdown(startDate, endDate){
      if(__countdownTimer) clearInterval(__countdownTimer);
      const daysEl = $("rDaysLeft");
      const cdEl = $("rCountdown");
      const fillEl = $("wFill");
      const pill = $("wStatusPill");
      const sub = $("wSubText");

      // set static dates in UI
      if($("rStart")) $("rStart").textContent = startDate ? fmt(startDate) : "-";
      if($("rEnd2")) $("rEnd2").textContent = endDate ? fmt(endDate) : "-";

      const totalMs = (startDate && endDate) ? (endDate - startDate) : (365*24*3600*1000);

      function tick(){
        const now = new Date();
        const diff = endDate - now;

        // progress
        if(startDate && endDate && fillEl){
          const elapsed = Math.max(0, Math.min(totalMs, now - startDate));
          const pct = totalMs > 0 ? Math.round((elapsed/totalMs)*100) : 0;
          fillEl.style.width = `${Math.max(0, Math.min(100, pct))}%`;
          sub.textContent = `ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ${pct}% Ù…Ù† Ù…Ø¯Ø© Ø§Ù„Ø¶Ù…Ø§Ù†`;
        } else if(sub){
          sub.textContent = "";
        }

        if(diff <= 0){
          daysEl.textContent = "0";
          cdEl.textContent = "Ø§Ù†ØªÙ‡Ù‰";
          pill.textContent = "Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¶Ù…Ø§Ù†";
          $("searchDot").className = "dot bad";
          $("searchStatusText").textContent = "ğŸ”´ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¶Ù…Ø§Ù†";
          if(__countdownTimer){ clearInterval(__countdownTimer); __countdownTimer = null; }
          return;
        }
        const totalSec = Math.floor(diff/1000);
        const days = Math.floor(totalSec/86400);
        const hrs = Math.floor((totalSec%86400)/3600);
        const mins = Math.floor((totalSec%3600)/60);
        const secs = totalSec%60;

        daysEl.textContent = String(days);
        cdEl.textContent = `${pad2(hrs)}:${pad2(mins)}:${pad2(secs)}`;
        pill.textContent = "Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù†";
      }
      tick();
      __countdownTimer = setInterval(tick, 1000);
    }

    function renderHistory(purchases){
      const wrap = $("rHistoryWrap");
      const box = $("rHistory");
      if(!purchases || !Array.isArray(purchases) || purchases.length === 0){
        wrap.classList.add("hidden");
        box.innerHTML = "";
        return;
      }
      // sort newest first by startISO
      const list = purchases
        .filter(p=>p && p.startISO && p.endISO)
        .slice()
        .sort((a,b)=> (new Date(b.startISO)) - (new Date(a.startISO)));

      wrap.classList.remove("hidden");
      box.innerHTML = list.map((p, i)=>{
        const s = p.startISO ? fmt(new Date(p.startISO)) : "-";
        const e = p.endISO ? fmt(new Date(p.endISO)) : "-";
        const img = p.invoiceImage ? `<img class="preview" alt="invoice ${i+1}" src="${p.invoiceImage}"/>` : "";
        return `
          <div class="result" style="margin-top:0">
            <div class="k">ÙØ§ØªÙˆØ±Ø© #${i+1}</div>
            <div class="v" style="margin-top:8px">
              <div style="display:grid;gap:6px">
                <div><span style="color:var(--muted2);font-size:12px">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¶Ù…Ø§Ù†:</span> ${s}</div>
                <div><span style="color:var(--muted2);font-size:12px">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†:</span> ${e}</div>
              </div>
              ${img ? `<div style="margin-top:10px">${img}</div>` : ``}
            </div>
          </div>
        `;
      }).join("");
    }

    $("activateBtn").addEventListener("click", async ()=>{
const fullName = normalizeName($("fullName").value);
      const phone = sanitizePhone($("phone").value);
      const img = window.__invoiceImageData;
      const isPrev = $("isPrevCustomer").checked;

      if(fullName.split(" ").length < 3) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ (3 ÙƒÙ„Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).");
      if(phone.length < 8) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­.");
      if(!img) return alert("ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ø²Ø§Ù…ÙŠØ© (Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ).");
      if(!db) return alert("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");

      try{
        const id = await customerId(fullName, phone);
        const ref = db.collection("customers").doc(id);
        const snap = await ref.get();

        if(snap.exists && !isPrev){
          alert("Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ† Ù…Ø´ØªØ±ÙŠ Ø³Ø§Ø¨Ù‚Ø§Ù‹ âœ…\nÙØ¹Ù‘Ù„ Ø²Ø± (Ø²Ø¨ÙˆÙ† Ø³Ø§Ø¨Ù‚) Ø­ØªÙ‰ ØªÚ¯Ø¯Ø± ØªØ¶ÙŠÙÙ‡ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.");
          return;
        }

        const now = new Date();
        const end = new Date(now);
        end.setDate(end.getDate() + WARRANTY_DAYS);

        const prevCount = snap.exists ? (snap.data().purchaseCount || 1) : 0;
        const newCount = snap.exists ? (prevCount + 1) : 1;

        
        const purchaseObj = {
          startISO: now.toISOString(),
          endISO: end.toISOString(),
          invoiceImage: img,
          createdAtISO: now.toISOString()
        };

        await ref.set({
          fullName,
          phone,
          // Ø¢Ø®Ø± Ø´Ø±Ø§Ø¡ (Ù„Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹)
          startISO: purchaseObj.startISO,
          endISO: purchaseObj.endISO,
          invoiceImage: purchaseObj.invoiceImage,
          // Ø³Ø¬Ù„ ÙƒÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª/Ø§Ù„ÙÙˆØ§ØªÙŠØ±
          purchases: snap.exists
            ? firebase.firestore.FieldValue.arrayUnion(purchaseObj)
            : [purchaseObj],
          purchaseCount: newCount,
          lastPurchaseAt: firebase.firestore.FieldValue.serverTimestamp(),
          isPrevCustomer: !!snap.exists,
        }, { merge:true });
$("resultBox").classList.remove("hidden");
        $("startDate").textContent = fmt(now);
        $("endDate").textContent = fmt(end);

        alert("ØªÙ… Ø­ÙØ¸ âœ…");
      }catch(e){
        alert("Ø®Ø·Ø£: " + (e?.message || e));
        console.log(e);
      }
    });

    $("searchBtn").addEventListener("click", async ()=>{
      const name = normalizeName($("searchName").value);
      const phone = sanitizePhone($("searchPhone").value);

      if(name.split(" ").length < 3) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ.");
      if(phone.length < 8) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.");
      if(!db) return alert("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");

      try{
        const id = await customerId(name, phone);
        const snap = await db.collection("customers").doc(id).get();
        if(!snap.exists){
          $("searchResult").classList.add("hidden");
          alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù….");
          return;
        }
        const d = snap.data() || {};

        $("rName").textContent = d.fullName || "-";
        $("rPhone").textContent = d.phone || "-";
        
        // Ø§Ø¹Ø±Ø¶ Ø¢Ø®Ø± ÙØªØ±Ø© Ø¶Ù…Ø§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ (Ø¥Ù† ÙˆØ¬Ø¯Øª)
        const purchases = Array.isArray(d.purchases) ? d.purchases : [];
        // ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±)
        if(purchases.length === 0 && (d.invoiceImage || d.startISO || d.endISO)){
          purchases.push({
            startISO: d.startISO || null,
            endISO: d.endISO || null,
            invoiceImage: d.invoiceImage || null,
            createdAtISO: null
          });
        }
        const latest = purchases.length
          ? purchases
              .filter(p=>p && p.endISO)
              .slice()
              .sort((a,b)=> (new Date(b.startISO||0)) - (new Date(a.startISO||0)))[0]
          : null;

        const endISO = (latest && latest.endISO) ? latest.endISO : d.endISO;
        $("rEnd").textContent = endISO ? formatEnd(endISO) : "-";
        if($("rEnd2")) $("rEnd2").textContent = endISO ? formatEnd(endISO) : "-";

        const count = purchases.length ? purchases.length : (d.purchaseCount || 1);
        $("rCount").textContent = count + " Ù…Ø±Ø©";

        // Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© + Ø§Ù„ØµÙˆØ±
        renderHistory(purchases);

        window.__lastCustomer = d;
        const rb = $("reportBtn");
        if(rb){ rb.onclick = ()=> openCustomerReport(window.__lastCustomer || d); }

        // Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ù…Ø§Ù† + Ø§Ù„Ø¹Ø¯Ù‘ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
        const end = endISO ? new Date(endISO) : null;
        const active = end ? (new Date() <= end) : false;
        $("searchDot").className = active ? "dot ok" : "dot bad";
        $("searchStatusText").textContent = active ? "ğŸŸ¢ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù†" : "ğŸ”´ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¶Ù…Ø§Ù†";

        if(end) startWarrantyCountdown(latest && latest.startISO ? new Date(latest.startISO) : (d.startISO ? new Date(d.startISO) : null), end);
        if($("rEnd2")) $("rEnd2").textContent = end ? fmt(end) : "-";


        $("searchResult").classList.remove("hidden");
        $("searchResult").scrollIntoView({behavior:"smooth", block:"start"});
      }catch(e){
        alert("Ø®Ø·Ø£: " + (e?.message || e));
        console.log(e);
      }
    });

    $("copyBtn").addEventListener("click", async ()=>{
      const t =
        "Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©\n" +
        "Ø§Ù„Ø§Ø³Ù…: " + ($("fullName").value||"") + "\n" +
        "Ø§Ù„Ù‡Ø§ØªÙ: " + ($("phone").value||"") + "\n" +
        "Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†: " + ($("endDate").textContent||"");
      try{ await navigator.clipboard.writeText(t); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“"); }
      catch(_ ){ alert(t); }
    });


    // ---- Customer Report (Print) ----
    function openCustomerReport(data){
      const name = data.fullName || "-";
      const phone = data.phone || "-";
      const purchases = Array.isArray(data.purchases) ? data.purchases : [];
      const list = purchases.slice().sort((a,b)=> (new Date(b.startISO||0)) - (new Date(a.startISO||0)));
      const latest = list[0] || null;
      const startISO = latest?.startISO || data.startISO || null;
      const endISO = latest?.endISO || data.endISO || null;

      const end = endISO ? new Date(endISO) : null;
      const now = new Date();
      const active = end ? (now <= end) : false;

      const diff = end ? (end - now) : 0;
      const totalSec = diff > 0 ? Math.floor(diff/1000) : 0;
      const days = diff > 0 ? Math.floor(totalSec/86400) : 0;

      const htmlDoc = `
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²Ø¨ÙˆÙ†</title>
<style>
  body{font-family: system-ui,-apple-system,"SF Pro Text","SF Pro Display",Arial; margin:18px; color:#111}
  .card{border:1px solid #ddd;border-radius:16px;padding:14px;margin:12px 0}
  h1{margin:0 0 8px;font-size:18px}
  .muted{color:#555;font-size:13px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .cell{flex:1;min-width:220px}
  img{max-width:100%;border-radius:14px;border:1px solid #e6e6e6}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #e6e6e6;padding:10px;text-align:right;font-size:13px;vertical-align:top}
  th{background:#f6f6f6}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #ddd;font-size:13px}
  .ok{background:#eaffea;border-color:#bfe9c3}
  .bad{background:#ffecec;border-color:#f1b7b7}
  @media print{ button{display:none} body{margin:0} }
</style>
</head>
<body>
  <div class="card">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div>
        <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²Ø¨ÙˆÙ†</h1>
        <div class="muted">Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</div>
      </div>
      <div class="badge ${active?'ok':'bad'}">${active?'Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù†':'Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¶Ù…Ø§Ù†'}</div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="cell"><div class="muted">Ø§Ù„Ø§Ø³Ù…</div><div style="font-size:16px;font-weight:700">${name}</div></div>
      <div class="cell"><div class="muted">Ø§Ù„Ù‡Ø§ØªÙ</div><div style="font-size:16px;font-weight:700">${phone}</div></div>
      <div class="cell"><div class="muted">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><div style="font-size:16px;font-weight:700">${days} ÙŠÙˆÙ…</div></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="cell"><div class="muted">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¶Ù…Ø§Ù†</div><div>${startISO ? new Date(startISO).toLocaleString() : '-'}</div></div>
      <div class="cell"><div class="muted">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</div><div>${endISO ? new Date(endISO).toLocaleString() : '-'}</div></div>
      <div class="cell"><div class="muted">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</div><div>${list.length || (data.purchaseCount||1)}</div></div>
    </div>

    <button onclick="window.print()" style="margin-top:12px;padding:12px 14px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
  </div>

  <div class="card">
    <h1 style="font-size:16px">Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h1>
    <div class="muted">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</div>
    <table>
      <thead>
        <tr>
          <th style="width:60px">#</th>
          <th>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¶Ù…Ø§Ù†</th>
          <th>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</th>
          <th>ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
        </tr>
      </thead>
      <tbody>
        ${list.map((p,i)=>`
          <tr>
            <td>${i+1}</td>
            <td>${p.startISO ? new Date(p.startISO).toLocaleString() : '-'}</td>
            <td>${p.endISO ? new Date(p.endISO).toLocaleString() : '-'}</td>
            <td>${p.invoiceImage ? `<img src="${p.invoiceImage}" alt="invoice ${i+1}"/>` : '-'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  </div>
</body>
</html>`;

      const w = window.open("", "_blank");
      if(!w){ alert("ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø­Ø¸Ø± Ø§Ù„Ù†ÙˆØ§ÙØ°)."); return; }
      w.document.open();
      w.document.write(htmlDoc);
      w.document.close();
    }
    showSearch();
  </script>
</body>
</html>
