<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</title>
  <meta name="theme-color" content="#061724" />
  <style>
    :root {
      --bg1:#04101A; --bg2:#071C2A;
      --glass: rgba(255,255,255,.09);
      --glass2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --muted2: rgba(255,255,255,.52);
      --blue:#0A84FF; --green:#32D74B; --red:#FF453A; --yellow:#FFD60A;
      --shadow: 0 18px 60px rgba(0,0,0,.46);
      --blur: 20px;
      --rXL: 28px; --rL: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display","SF Pro Text","Segoe UI", Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 18% 0%, rgba(10,132,255,.26), transparent 58%),
        radial-gradient(900px 650px at 110% 10%, rgba(50,215,75,.16), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      -webkit-font-smoothing: antialiased;
      overflow-x:hidden;
    }
    .wrap{max-width:980px;margin:0 auto;padding:max(18px,env(safe-area-inset-top)) 14px 70px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 10px 0}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{width:46px;height:46px;border-radius:16px;flex:none;
      background:
        radial-gradient(circle at 30% 20%, rgba(10,132,255,.95), rgba(10,132,255,.20)),
        radial-gradient(circle at 80% 80%, rgba(50,215,75,.60), rgba(50,215,75,.06));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.22), 0 18px 40px rgba(0,0,0,.30);
    }
    .title h1{margin:0;font-size:20px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .title .sub{margin-top:4px;font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pillbtn{
      border:none;color:var(--text);cursor:pointer;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      padding:10px 14px;border-radius:999px;
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .card{
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:var(--rXL);
      box-shadow:var(--shadow);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
    }
    .hero{margin:12px 10px 14px;padding:18px}
    .hero h2{margin:0;font-size:22px}
    .hero p{margin:8px 0 0;line-height:1.6;color:var(--muted)}
    .seg{margin-top:14px;display:flex;gap:6px;padding:6px;background:rgba(0,0,0,.16);
      border:1px solid var(--stroke2);border-radius:18px;}
    .seg button{flex:1;border:none;cursor:pointer;padding:12px;border-radius:14px;font-size:15px;
      color:var(--muted);background:transparent;transition:.18s ease;}
    .seg button.active{color:var(--text);background:rgba(255,255,255,.13);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);}
    .status{margin-top:12px;display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:18px;
      background:rgba(0,0,0,.18);border:1px solid var(--stroke2);}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--yellow);box-shadow:0 0 0 4px rgba(255,214,10,.14)}
    .dot.ok{background:var(--green);box-shadow:0 0 0 4px rgba(50,215,75,.14)}
    .dot.bad{background:var(--red);box-shadow:0 0 0 4px rgba(255,69,58,.14)}
    .section{margin:12px 10px;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
    label{display:block;margin:2px 10px 8px;font-size:13px;color:var(--muted)}
    input,textarea{width:100%;border-radius:18px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);color:var(--text);padding:14px;font-size:16px;outline:none;}
    .help{margin-top:6px;font-size:12px;color:var(--muted2);padding:0 10px;line-height:1.6}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .btn{flex:1;min-width:170px;cursor:pointer;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.10);color:var(--text);border-radius:18px;padding:14px;font-size:16px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);}
    .btn.primary{background:linear-gradient(180deg, rgba(10,132,255,.95), rgba(10,132,255,.72));
      box-shadow:0 14px 35px rgba(10,132,255,.20);}
    .btn.ghost{background:rgba(0,0,0,.18)}
    .result{margin-top:14px;padding:14px;border-radius:var(--rL);background:var(--glass2);border:1px solid rgba(255,255,255,.14)}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){.kv{grid-template-columns:1fr}}
    .k{font-size:12px;color:var(--muted2);padding:0 4px}
    .v{font-size:16px;margin-top:4px;padding:0 4px;line-height:1.6;white-space:pre-wrap}
    .hidden{display:none !important}
    img.preview{width:100%;border-radius:18px;border:1px solid rgba(255,255,255,.14)}
    .badge{margin-top:12px;display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:18px;background:rgba(0,0,0,.18);border:1px solid var(--stroke2)}

    /* iOS style switch */
    .switchRow{display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border-radius:18px;background:rgba(0,0,0,.18);border:1px solid var(--stroke2);}
    .switchRow .txt{font-size:14px;color:var(--text)}
    .switch{position:relative;width:54px;height:32px;flex:none}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;inset:0;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.16);
      transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:26px;width:26px;right:3px;top:2px;background:white;border-radius:999px;transition:.2s}
    .switch input:checked + .slider{background:rgba(50,215,75,.55)}
    .switch input:checked + .slider:before{transform:translateX(-22px)}
  
    .historyWrap{margin-top:14px; padding-top:10px; border-top:1px dashed var(--stroke2); display:none}
    .hTitle{font-size:13px; color:rgba(255,255,255,.78); margin-bottom:10px}
    .historyList{display:grid; gap:10px}
    .pCard{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:12px}
    .pTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
    .pTag{font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12)}
    .pTag.ok{background:rgba(52,211,153,.12); border-color:rgba(52,211,153,.28)}
    .pTag.bad{background:rgba(244,63,94,.12); border-color:rgba(244,63,94,.28)}
    .pMeta{font-size:13px; color:rgba(255,255,255,.82); line-height:1.6}
    .pMeta b{color:#fff}
    .pImg{margin-top:10px}
    .pImg img{width:100%; max-height:320px; object-fit:cover; border-radius:14px; border:1px solid rgba(255,255,255,.14)}

</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</h1>
          <div class="sub">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† â€¢ Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</div>
        </div>
      </div>
      <button class="pillbtn" id="resetBtn" type="button">Ø¥Ø¹Ø§Ø¯Ø©</button>
    </div>

    <div class="card hero">
      <h2 id="pageTitle">Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</h2>
      <p id="pageDesc">Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø©.</p>

      <!-- Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© Ø«Ø§Ø¨ØªØ© -->
      <div class="result" id="welcomeBanner">
        <div class="k">ğŸ‰ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ©</div>
        <div class="v" style="line-height:1.75;margin-top:6px">
          Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø´Ø±Ø§Ø¡ <b>Ø¬Ù‡Ø§Ø² Ø£ØµÙ„ÙŠ</b> ÙˆØ¨Ù€ <b>Ø¶Ù…Ø§Ù† Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù…Ø¯Ø© Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©</b> âœ…
          <br/>Ù…Ù† <b>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</b> â€” Ù…Ù…ÙŠØ²Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆØ®Ø¯Ù…Ø© Ù…ØªØ§Ø¨Ø¹Ø©.
        </div>
      </div>

      <div class="seg" role="tablist">
        <button id="goSearch" class="active" type="button">Ø¨Ø­Ø«</button>
        <button id="goActivate" type="button">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</button>
      </div>

      <div class="status">
        <span class="dot" id="statusDot"></span>
        <span id="cloudStatus" style="color:var(--muted)">... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
      </div>

      <div class="result" id="errBox" style="display:none;direction:ltr;text-align:left;white-space:pre-wrap"></div>
    </div>

    <!-- Search -->
    <div class="card section" id="searchCard">
      <div class="grid">
        <div>
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
          <input id="searchName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" />
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="searchPhone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" inputmode="tel" />
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="searchBtn" type="button">Ø¨Ø­Ø«</button>
        <button class="btn" id="searchClearBtn" type="button">Ù…Ø³Ø­</button>
      </div>

      <div class="result hidden" id="searchResult">
        <div class="kv">
          <div><div class="k">Ø§Ù„Ø§Ø³Ù…</div><div class="v" id="rName">-</div></div>
          <div><div class="k">Ø§Ù„Ù‡Ø§ØªÙ</div><div class="v" id="rPhone">-</div></div>
          <div style="grid-column:1/-1"><div class="k">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</div><div class="v" id="rEnd">-</div></div>
          <div style="grid-column:1/-1"><div class="k">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</div><div class="v" id="rCount">-</div></div>
          <div style="grid-column:1/-1" id="rImageWrap" class="hidden">
            <div class="k">ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
            <div class="v"><img id="rImage" class="preview" alt="invoice image"/></div>
          </div>
        </div>
        
        <div class="historyWrap" id="purchaseHistoryWrap">
          <div class="hTitle">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
          <div id="purchaseHistory" class="historyList"></div>
        </div>

        <div class="badge">
          <span class="dot" id="searchDot"></span>
          <span id="searchStatusText">-</span>
        </div>
      </div>
    </div>

    <!-- Activate -->
    <div class="card section hidden" id="activateCard">
      <div class="switchRow">
        <div class="txt">Ø²Ø¨ÙˆÙ† Ø³Ø§Ø¨Ù‚ (Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©)</div>
        <label class="switch">
          <input id="isPrevCustomer" type="checkbox" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="help">Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø¨ÙˆÙ† Ù…Ø´ØªØ±ÙŠ Ø³Ø§Ø¨Ù‚Ø§Ù‹ ÙˆØªØ±ÙŠØ¯ ØªØ¶ÙŠÙÙ‡ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©ØŒ ÙØ¹Ù‘Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ø«Ù… Ø§Ø¶ØºØ· ØªÙØ¹ÙŠÙ„.</div>

      <div class="grid" style="margin-top:12px">
        <div>
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
          <input id="fullName" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ±Ø§Ø± Ù†Ø¨ÙŠÙ„ Ø£ÙƒØ±Ù…" />
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="phone" placeholder="0772xxxxxxx Ø£Ùˆ 9647xxxxxxxxx" inputmode="tel" />
        </div>

        <div style="grid-column:1/-1">
          <label>ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
          <input id="imgFromCamera" type="file" accept="image/*" capture="environment" class="hidden" />
          <input id="imgFromGallery" type="file" accept="image/*" class="hidden" />
          <div class="row" style="margin-top:0">
            <button class="btn primary" id="btnCamera" type="button">ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
            <button class="btn ghost" id="btnGallery" type="button">ğŸ–¼ï¸ Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
          </div>
          <div class="help">Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ â€” ØªÙ†Ø­ÙØ¸ ÙˆØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ø¨Ø­Ø«.</div>
          <div class="result hidden" id="imgPreviewBox" style="margin-top:10px">
            <div class="k">Ù…Ø¹Ø§ÙŠÙ†Ø©</div>
            <div class="v"><img id="imgPreview" class="preview" /></div>
          </div>
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="activateBtn" type="button">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</button>
        <button class="btn" id="copyBtn" type="button">Ù†Ø³Ø®</button>
      </div>

      <div class="result hidden" id="resultBox">
        <div class="kv">
          <div><div class="k">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¶Ù…Ø§Ù†</div><div class="v" id="startDate">-</div></div>
          <div><div class="k">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</div><div class="v" id="endDate">-</div></div>
        </div>
      </div>

      <div class="help" style="margin-top:12px">Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©: <b>9647722806645</b></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {"apiKey": "AIzaSyBMZbRFRU5-GyAmEwLHDspnY6PkEcaz6Ak", "authDomain": "albaman-f8a20.firebaseapp.com", "projectId": "albaman-f8a20", "storageBucket": "albaman-f8a20.firebasestorage.app", "messagingSenderId": "770267943286", "appId": "1:770267943286:web:e3da1c43d65740d7b52a57", "measurementId": "G-CB2PYMZSZT"};
    const HELP_PHONE = "9647722806645";
    const WARRANTY_DAYS = 365;

    const $ = (id)=>document.getElementById(id);

    function setConn(state, msg){
      const dot = $("statusDot");
      dot.className = "dot" + (state==="ok" ? " ok" : state==="bad" ? " bad" : "");
      $("cloudStatus").textContent = msg;
    }
    function showErr(msg){
      const el = $("errBox");
      if(!msg){ el.style.display="none"; el.textContent=""; return; }
      el.style.display="block"; el.textContent = String(msg);
    }
    function normalizeDigits(str){
      return (str||"")
        .replace(/[Ù -Ù©]/g, d => String("Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d)))
        .replace(/[Û°-Û¹]/g, d => String("Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)));
    }
    function sanitizePhone(p){ return normalizeDigits((p||"").trim().replace(/\s+/g,"")); }
    function normalizeName(n){ return (n||"").trim().replace(/\s+/g," "); }

    function fmt(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const da=String(d.getDate()).padStart(2,"0");
      const hh=String(d.getHours()).padStart(2,"0");
      const mm=String(d.getMinutes()).padStart(2,"0");
      return `${y}-${m}-${da} ${hh}:${mm}`;
    }

    function showSearch(){
      $("searchCard").classList.remove("hidden");
      $("activateCard").classList.add("hidden");
      $("goSearch").classList.add("active");
      $("goActivate").classList.remove("active");
      $("pageTitle").textContent="Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†";
      $("pageDesc").textContent="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø©.";
      window.scrollTo({top:0, behavior:"smooth"});
    }
    function showActivate(){
      $("activateCard").classList.remove("hidden");
      $("searchCard").classList.add("hidden");
      $("goActivate").classList.add("active");
      $("goSearch").classList.remove("active");
      $("pageTitle").textContent="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†";
      $("pageDesc").textContent="Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ + Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ + ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©.";
      window.scrollTo({top:0, behavior:"smooth"});
    }

    $("goSearch").addEventListener("click", showSearch);
    $("goActivate").addEventListener("click", showActivate);

    $("resetBtn").addEventListener("click", ()=>{
      ["fullName","phone","searchName","searchPhone"].forEach(id=>{ const el=$(id); if(el) el.value=""; });
      $("searchResult").classList.add("hidden");
      $("resultBox").classList.add("hidden");
      $("imgPreviewBox").classList.add("hidden");
      window.__invoiceImageData = null;
      $("isPrevCustomer").checked = false;
      showSearch();
    });

    $("searchClearBtn").addEventListener("click", ()=>{
      $("searchName").value=""; $("searchPhone").value="";
      $("searchResult").classList.add("hidden");
    });

    // ---- Image (camera or gallery) -> Base64 + preview ----
    window.__invoiceImageData = null;

    async function fileToCompressedDataURL(file, maxSide=1600, quality=0.78){
      const img = new Image();
      const url = URL.createObjectURL(file);
      await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; img.src=url; });
      const w = img.naturalWidth, h = img.naturalHeight;
      const scale = Math.min(1, maxSide / Math.max(w,h));
      const nw = Math.round(w*scale), nh = Math.round(h*scale);
      const canvas = document.createElement("canvas");
      canvas.width=nw; canvas.height=nh;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img,0,0,nw,nh);
      URL.revokeObjectURL(url);
      return canvas.toDataURL("image/jpeg", quality);
    }

    async function handlePickedFile(file){
      if(!file) return;
      try{
        const dataUrl = await fileToCompressedDataURL(file);
        window.__invoiceImageData = dataUrl;
        $("imgPreview").src = dataUrl;
        $("imgPreviewBox").classList.remove("hidden");
      }catch(err){
        alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©");
        console.log(err);
      }
    }

    $("btnCamera").addEventListener("click", ()=> $("imgFromCamera").click());
    $("btnGallery").addEventListener("click", ()=> $("imgFromGallery").click());
    $("imgFromCamera").addEventListener("change", (e)=> handlePickedFile(e.target.files && e.target.files[0]));
    $("imgFromGallery").addEventListener("change", (e)=> handlePickedFile(e.target.files && e.target.files[0]));

    // ---- Firestore ----
    let db = null;
    try{
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    }catch(e){
      setConn("bad","âŒ Ø®Ø·Ø£ Ø¨ØªÙ‡ÙŠØ¦Ø© Firebase");
      showErr(e?.message || e);
    }

    async function ping(){
      if(!db) return;
      try{
        await db.collection("_health").doc("ping").get();
        setConn("ok","âœ… Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firestore)");
        showErr("");
      }catch(e){
        setConn("bad","âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        showErr((e?.code?e.code:"error")+": "+(e?.message||e));
      }
    }
    setConn("warn","... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    ping();

    async function sha256hex(s){
      const enc = new TextEncoder().encode(s);
      const hash = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    async function customerId(name, phone){
      return sha256hex(normalizeName(name).toLowerCase() + "|" + sanitizePhone(phone));
    }

    function formatEnd(endISO){
      const end = new Date(endISO);
      return fmt(end);
    }
    function daysBetween(a,b){
      const ms = b.getTime() - a.getTime();
      return ms / (1000*60*60*24);
    }
    function warrantyStatus(endISO){
      const end = new Date(endISO);
      const now = new Date();
      const diffDays = daysBetween(now, end);
      if(diffDays >= 0){
        const d = Math.floor(diffDays);
        const h = Math.floor((diffDays - d)*24);
        if(d <= 0) return { ok:true, text:`ğŸŸ¢ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù† (Ù…ØªØ¨Ù‚ÙŠ ${h} Ø³Ø§Ø¹Ø©)` , cls:"ok" };
        return { ok:true, text:`ğŸŸ¢ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù† (Ù…ØªØ¨Ù‚ÙŠ ${d} ÙŠÙˆÙ…)` , cls:"ok" };
      }else{
        const d = Math.abs(Math.ceil(diffDays));
        return { ok:false, text:`ğŸ”´ Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ù†ØªÙ‡ÙŠ (Ù…Ù†Ø° ${d} ÙŠÙˆÙ…)` , cls:"bad" };
      }
    }
    function renderHistory(purchases){
      const wrap = $("purchaseHistoryWrap");
      const list = $("purchaseHistory");
      list.innerHTML = "";
      if(!Array.isArray(purchases) || purchases.length === 0){
        wrap.style.display = "none";
        return;
      }
      // sort newest first by startISO
      purchases = purchases.slice().sort((a,b)=>String(b.startISO||"").localeCompare(String(a.startISO||"")));
      purchases.forEach((p, i)=>{
        const st = p.startISO ? fmt(new Date(p.startISO)) : "-";
        const en = p.endISO ? fmt(new Date(p.endISO)) : "-";
        const s = p.endISO ? warrantyStatus(p.endISO) : {ok:false,text:"-",cls:""};
        const card = document.createElement("div");
        card.className = "pCard";
        card.innerHTML = `
          <div class="pTop">
            <div class="pTag ${s.cls}">${i===0 ? "Ø§Ù„Ø£Ø­Ø¯Ø«" : "Ø³Ø§Ø¨Ù‚"} â€¢ ${s.text}</div>
            <div class="pTag">#${purchases.length - i}</div>
          </div>
          <div class="pMeta">
            <div><b>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¶Ù…Ø§Ù†:</b> ${st}</div>
            <div><b>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†:</b> ${en}</div>
          </div>
          ${p.invoiceImage ? `<div class="pImg"><img src="${p.invoiceImage}" alt="invoice"/></div>` : ``}
        `;
        list.appendChild(card);
      });
      wrap.style.display = "block";
    }


    $("activateBtn").addEventListener("click", async ()=>{
      const fullName = normalizeName($("fullName").value);
      const phone = sanitizePhone($("phone").value);
      const img = window.__invoiceImageData;
      const isPrev = $("isPrevCustomer").checked;

      if(fullName.split(" ").length < 3) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ (3 ÙƒÙ„Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).");
      if(phone.length < 8) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­.");
      if(!img) return alert("ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ø²Ø§Ù…ÙŠØ© (Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ).");
      if(!db) return alert("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");

      try{
        const id = await customerId(fullName, phone);
        const ref = db.collection("customers").doc(id);
        const snap = await ref.get();

        if(snap.exists && !isPrev){
          alert("Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ† Ù…Ø´ØªØ±ÙŠ Ø³Ø§Ø¨Ù‚Ø§Ù‹ âœ…\nÙØ¹Ù‘Ù„ Ø²Ø± (Ø²Ø¨ÙˆÙ† Ø³Ø§Ø¨Ù‚) Ø­ØªÙ‰ ØªÚ¯Ø¯Ø± ØªØ¶ÙŠÙÙ‡ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.");
          return;
        }

        const now = new Date();
        const end = new Date(now);
        end.setDate(end.getDate() + WARRANTY_DAYS);

        const prevCount = snap.exists ? (snap.data().purchaseCount || 1) : 0;
        const newCount = snap.exists ? (prevCount + 1) : 1;

        await ref.set({
          fullName,
          phone,
          // latest purchase (for quick display)
          invoiceImage: img,
          startISO: now.toISOString(),
          endISO: end.toISOString(),
          purchaseCount: newCount,
          lastPurchaseAt: firebase.firestore.FieldValue.serverTimestamp(),
          isPrevCustomer: !!snap.exists,
          // full history
          purchases: firebase.firestore.FieldValue.arrayUnion({
            startISO: now.toISOString(),
            endISO: end.toISOString(),
            invoiceImage: img,
            createdAtISO: now.toISOString()
          })
        }, { merge:true });

        $("resultBox").classList.remove("hidden");
        $("startDate").textContent = fmt(now);
        $("endDate").textContent = fmt(end);

        alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† âœ…");
      }catch(e){
        alert("Ø®Ø·Ø£: " + (e?.message || e));
        console.log(e);
      }
    });

    $("searchBtn").addEventListener("click", async ()=>{
      const name = normalizeName($("searchName").value);
      const phone = sanitizePhone($("searchPhone").value);

      if(name.split(" ").length < 3) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ.");
      if(phone.length < 8) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.");
      if(!db) return alert("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");

      try{
        const id = await customerId(name, phone);
        const snap = await db.collection("customers").doc(id).get();
        if(!snap.exists){
          $("searchResult").classList.add("hidden");
          alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù….");
          return;
        }
        const d = snap.data() || {};

        $("rName").textContent = d.fullName || "-";
        $("rPhone").textContent = d.phone || "-";
        $("rEnd").textContent = d.endISO ? formatEnd(d.endISO) : "-";
        $("rCount").textContent = ((d.purchaseCount || (Array.isArray(d.purchases)?d.purchases.length:1)) || 1) + " Ù…Ø±Ø©";

        if(d.invoiceImage){
          $("rImage").src = d.invoiceImage;
          $("rImageWrap").classList.remove("hidden");
        } else {
          $("rImageWrap").classList.add("hidden");
        }

        // Build purchases history (new schema) or fallback (old schema)
        let purchases = Array.isArray(d.purchases) ? d.purchases : [];
        if(purchases.length === 0 && (d.startISO || d.endISO || d.invoiceImage)){
          purchases = [{
            startISO: d.startISO || "",
            endISO: d.endISO || "",
            invoiceImage: d.invoiceImage || "",
            createdAtISO: d.startISO || ""
          }];
        }

        // Overall status based on latest end date
        const latest = purchases.slice().sort((a,b)=>String(b.endISO||"").localeCompare(String(a.endISO||"")))[0];
        const s = (latest && latest.endISO) ? warrantyStatus(latest.endISO) : {ok:false,text:"-",cls:"bad"};
        $("searchDot").className = "dot " + (s.ok ? "ok" : "bad");
        $("searchStatusText").textContent = s.text;

        // Render history cards (all purchases)
        renderHistory(purchases);

        $("searchResult").classList.remove("hidden");
        $("searchResult").scrollIntoView({behavior:"smooth", block:"start"});
      }catch(e){
        alert("Ø®Ø·Ø£: " + (e?.message || e));
        console.log(e);
      }
    });

    $("copyBtn").addEventListener("click", async ()=>{
      const t =
        "Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©\n" +
        "Ø§Ù„Ø§Ø³Ù…: " + ($("fullName").value||"") + "\n" +
        "Ø§Ù„Ù‡Ø§ØªÙ: " + ($("phone").value||"") + "\n" +
        "Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†: " + ($("endDate").textContent||"");
      try{ await navigator.clipboard.writeText(t); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“"); }
      catch(_ ){ alert(t); }
    });

    showSearch();
  </script>
</body>
</html>
