<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† | ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† ÙˆØ§Ù„ØªØ­Ù‚Ù‚</title>
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0a2a3a;
      --card: rgba(255,255,255,.10);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 22px;
      --good: rgba(52,199,89,1);
      --warn: rgba(255,159,10,1);
      --bad: rgba(255,69,58,1);
      --blue: rgba(10,132,255,1);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Segoe UI",Roboto,Arial,"Noto Kufi Arabic","Noto Sans Arabic",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(10,132,255,.25), transparent 60%),
        radial-gradient(1000px 700px at 80% 0%, rgba(52,199,89,.18), transparent 55%),
        radial-gradient(900px 900px at 60% 80%, rgba(255,159,10,.14), transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh;
      display:flex; justify-content:center;
      padding: 22px 14px 28px;
    }
    .phone{width:min(440px,100%)}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 8px 6px 14px;}
    .brand{display:flex; align-items:center; gap:10px; min-width:0}
    .logo{
      width:42px; height:42px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(10,132,255,.95), rgba(52,199,89,.85));
      box-shadow: 0 10px 30px rgba(10,132,255,.25);
      position:relative; overflow:hidden; flex: 0 0 auto;
    }
    .logo:after{
      content:""; position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 45%);
      transform: rotate(12deg);
    }
    .brandtext{min-width:0}
    .brandtext .title{font-size:16px;font-weight:950;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .brandtext .subtitle{margin-top:2px;font-size:12.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .card{
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, var(--card), var(--card2));
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      margin-bottom: 14px;
    }
    .hero h1{ margin:0 0 6px; font-size:18px; font-weight:980; letter-spacing:.2px; }
    .hero p{ margin:0; color:var(--muted); font-size:13.5px; line-height:1.5; }

    .seg{display:flex; gap:10px; margin-top: 14px;}
    .btn{
      flex:1;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding: 13px 12px;
      border-radius: 18px;
      font-weight: 980;
      font-size: 14px;
      letter-spacing: .2px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      cursor:pointer;
      transition: transform .15s ease, background .15s ease;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      text-align:center;
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(10,132,255,.95), rgba(10,132,255,.55));
      border-color: rgba(10,132,255,.55);
    }
    .btn.good{
      background: linear-gradient(135deg, rgba(52,199,89,.95), rgba(52,199,89,.55));
      border-color: rgba(52,199,89,.55);
    }
    .btn.ghost{ background: rgba(255,255,255,.07); }
    .btn.full{ width:100%; flex:unset; }

    .grid{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top: 12px; }
    .row{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
    }
    .label{ color: var(--muted); font-size: 12.5px; }
    .value{ font-size: 13.5px; font-weight: 980; text-align:left; direction:ltr; }

    .badge{
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 980;
      letter-spacing: .2px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .dot{ width:9px; height:9px; border-radius:999px; background: var(--good); box-shadow: 0 0 0 4px rgba(52,199,89,.18); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 4px rgba(255,159,10,.18); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 4px rgba(255,69,58,.18); }

    .sep{ height:1px; background: rgba(255,255,255,.12); margin: 12px 0; border-radius: 999px; }

    input, select, textarea{
      width:100%;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 16px;
      padding: 13px 12px;
      outline:none;
      font-size: 14px;
      font-weight: 880;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.45); font-weight: 780; }
    textarea{ min-height: 84px; resize:none; line-height:1.4; }
    .two{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .hint{ margin-top:8px; color: rgba(255,255,255,.62); font-size: 12.5px; line-height: 1.4; }

    .hidden{ display:none !important; }

    .countdown{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .tick{
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 12px 10px;
      text-align:center;
    }
    .tick .n{ font-size: 18px; font-weight: 990; direction:ltr; }
    .tick .t{ margin-top:4px; font-size: 12px; color: var(--muted); font-weight: 920; }

    .footer{
      text-align:center;
      color: rgba(255,255,255,.55);
      font-size: 12px;
      margin-top: 10px;
      padding: 6px 0 0;
    }
  </style>
</head>

<body>
  <div class="phone">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandtext">
          <div class="title">Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</div>
          <div class="subtitle">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† â€¢ Ø¨Ø­Ø« ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</div>
        </div>
      </div>
    </div>

    <div class="card hero">
      <h1 id="pageTitle">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</h1>
      <p id="pageDesc">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· â€œØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†â€ Ù„ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù…Ø¯Ø© Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©.</p>

      <div class="seg">
        <button class="btn primary" id="goActivate" type="button">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</button>
        <button class="btn ghost" id="goSearch" type="button">Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</button>
      </div>

      <div class="footer" id="cloudStatus">â€¦ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
<div class="footer" id="debugBox" style="display:none;white-space:pre-wrap;text-align:start;direction:ltr;margin-top:6px;opacity:.85"></div>
    </div>

    <!-- ACTIVATION -->
    <div class="card" id="activateCard">
      <div class="badge" id="statusBadge" style="display:none;">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">ğŸŸ¢ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù†</span>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div>
          <div class="label" style="margin:0 2px 8px;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</div>
          <input id="fullName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø­Ø³Ù†" autocomplete="name" />
        </div>

        <div class="two">
          <div>
            <div class="label" style="margin:0 2px 8px;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</div>
            <input id="phone" placeholder="Ù…Ø«Ø§Ù„: 9647XXXXXXXXX" inputmode="tel" />
            <div class="hint">ÙŠÙØ¶Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø¨ØµÙŠØºØ© Ø¯ÙˆÙ„ÙŠØ©.</div>
          </div>
          <div>
            <div class="label" style="margin:0 2px 8px;">Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²</div>
            <input id="model" placeholder="Ù…Ø«Ø§Ù„: 55UHD-2025" />
          </div>
        </div>

        <div>
          <div class="label" style="margin:0 2px 8px;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„</div>
          <textarea id="address" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© - Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© - Ø§Ù„Ù…Ù†Ø·Ù‚Ø© - Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø© Ø¯Ø§Ù„Ø©"></textarea>
        </div>

        <div class="two">
          <div>
            <div class="label" style="margin:0 2px 8px;">Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø´Ø§Ø´Ø©</div>
            <select id="series">
              <option value="LGOLED">LGOLED</option>
              <option value="LGUHD" selected>LGUHD</option>
              <option value="LGQNED">LGQNED</option>
              <option value="ILG">ILG</option>
              <option value="PROLG">PROLG</option>
              <option value="GENERAL">GENERAL</option>
              <option value="LGPRO">LGPRO</option>
              <option value="LGDAIMOND">LGDAIMOND</option>
            </select>
          </div>
          <div>
            <div class="label" style="margin:0 2px 8px;">ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
            <input id="code" placeholder="Ù…Ø«Ø§Ù„: DG-25A7K9" />
            <div class="hint">Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ QR: ÙŠÙ…Ø±Ø± Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø«Ù„ <span dir="ltr">?code=DG-XXXX</span>.</div>
          </div>
        </div>

        <button class="btn good full" id="activateBtn" type="button">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</button>
      </div>

      <div id="resultBox" class="hidden" style="margin-top:12px;">
        <div class="sep"></div>

        <div class="grid" style="margin-top:0;">
          <div class="row">
            <div class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙØ¹ÙŠÙ„</div>
            <div class="value" id="startDate"></div>
          </div>
          <div class="row">
            <div class="label">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†</div>
            <div class="value" id="endDate"></div>
          </div>
        </div>

        <div class="countdown">
          <div class="tick"><div class="n" id="d">0</div><div class="t">ÙŠÙˆÙ…</div></div>
          <div class="tick"><div class="n" id="h">0</div><div class="t">Ø³Ø§Ø¹Ø©</div></div>
          <div class="tick"><div class="n" id="m">0</div><div class="t">Ø¯Ù‚ÙŠÙ‚Ø©</div></div>
          <div class="tick"><div class="n" id="s">0</div><div class="t">Ø«Ø§Ù†ÙŠØ©</div></div>
        </div>

        <div class="seg">
          <button class="btn primary" id="callHelp" type="button">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</button>
          <button class="btn" id="copyInfo" type="button">Ù†Ø³Ø® Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¶Ù…Ø§Ù†</button>
        </div>
      </div>

      <div class="footer">Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©: <span style="font-weight:980; direction:ltr; display:inline-block;">9647722806645</span></div>
    </div>

    <!-- SEARCH -->
    <div class="card hidden" id="searchCard">
      <div class="badge">
        <span class="dot warn"></span>
        <span>Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</span>
      </div>

      <div class="grid">
        <div>
          <div class="label" style="margin:0 2px 8px;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</div>
          <input id="searchName" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" autocomplete="name" />
        </div>
        <div>
          <div class="label" style="margin:0 2px 8px;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</div>
          <input id="searchPhone" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" inputmode="tel" />
        </div>

        <button class="btn primary full" id="searchBtn" type="button">Ø¨Ø­Ø«</button>
      </div>

      <div id="searchResult" class="hidden" style="margin-top:12px;">
        <div class="sep"></div>
        <div class="badge">
          <span class="dot" id="searchDot"></span>
          <span id="searchStatusText">ğŸŸ¢ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù†</span>
        </div>

        <div class="grid">
          <div class="row">
            <div class="label">Ø§Ù„Ø§Ø³Ù…</div>
            <div class="value" id="rName" style="direction:rtl;text-align:right;"></div>
          </div>
          <div class="row">
            <div class="label">Ø§Ù„Ù‡Ø§ØªÙ</div>
            <div class="value" id="rPhone"></div>
          </div>
          <div class="row">
            <div class="label">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</div>
            <div class="value" id="rModel" style="direction:rtl;text-align:right;"></div>
          </div>
          <div class="row">
            <div class="label">Ø§Ù„Ø³Ù„Ø³Ù„Ø©</div>
            <div class="value" id="rSeries" style="direction:ltr;"></div>
          </div>
          <div class="row">
            <div class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</div>
            <div class="value" id="rEnd"></div>
          </div>
        </div>

        <div class="seg">
          <button class="btn" id="backBtn" type="button">Ø±Ø¬ÙˆØ¹</button>
          <button class="btn good" id="callHelp2" type="button">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</button>
        </div>
      </div>

      <div class="footer" id="searchNote">Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ + Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø«.</div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBMZbRFRU5-GyAmEwLHDspnY6PkEcaz6Ak",
    authDomain: "albaman-f8a20.firebaseapp.com",
    projectId: "albaman-f8a20",
    storageBucket: "albaman-f8a20.firebasestorage.app",
    messagingSenderId: "770267943286",
    appId: "1:770267943286:web:e3da1c43d65740d7b52a57",
    measurementId: "G-CB2PYMZSZT"
  };

  const HELP_PHONE = "9647722806645";
  const WARRANTY_DAYS = 365;
  const COLLECTION = "warranties";

  const $ = (id) => document.getElementById(id);
  
  const debugBox = document.getElementById("debugBox");
  function showDebug(msg){
    if(!debugBox) return;
    debugBox.style.display = msg ? "block" : "none";
    debugBox.textContent = msg ? String(msg) : "";
  }
function sanitizePhone(p){ return (p || "").trim().replace(/\s+/g,""); }
  function normalizeName(n){ return (n || "").trim().replace(/\s+/g," "); }
  function makeKey(name, phone){ return `${normalizeName(name).toLowerCase()}|${sanitizePhone(phone)}`; }

  function formatDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }
  function addDays(date, days){ const d = new Date(date); d.setDate(d.getDate()+days); return d; }

  function showActivate(){
    $("activateCard").classList.remove("hidden");
    $("searchCard").classList.add("hidden");
    $("pageTitle").textContent = "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†";
    $("pageDesc").textContent = "Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· â€œØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†â€ Ù„ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù…Ø¯Ø© Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©.";
  }
  function showSearch(){
    $("activateCard").classList.add("hidden");
    $("searchCard").classList.remove("hidden");
    $("pageTitle").textContent = "Ø¨Ø­Ø« Ø¹Ù† ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†";
    $("pageDesc").textContent = "Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†.";
  }
  $("goActivate").addEventListener("click", showActivate);
  $("goSearch").addEventListener("click", showSearch);

  function setStatus(active, message){
    const badge = $("statusBadge");
    const dot = $("statusDot");
    const text = $("statusText");
    badge.style.display = "inline-flex";
    if(active === true){
      dot.className = "dot";
      text.textContent = message || "ğŸŸ¢ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù†";
    }else if(active === false){
      dot.className = "dot bad";
      text.textContent = message || "ğŸ”´ Ø§Ù„Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù†Ø§ÙØ°";
    }else{
      dot.className = "dot warn";
      text.textContent = message || "âš ï¸ ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    }
  }

  let timer=null;
  function startCountdown(endDate){
    if(timer) clearInterval(timer);
    function tick(){
      const now = new Date();
      const diff = endDate - now;
      if(diff <= 0){
        $("d").textContent="0"; $("h").textContent="0"; $("m").textContent="0"; $("s").textContent="0";
        setStatus(false, "ğŸ”´ Ø§Ù„Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù†Ø§ÙØ°");
        clearInterval(timer); timer=null; return;
      }
      const totalSeconds = Math.floor(diff/1000);
      const days = Math.floor(totalSeconds/(24*3600));
      const hours = Math.floor((totalSeconds%(24*3600))/3600);
      const mins = Math.floor((totalSeconds%3600)/60);
      const secs = totalSeconds%60;

      $("d").textContent=String(days);
      $("h").textContent=String(hours).padStart(2,'0');
      $("m").textContent=String(mins).padStart(2,'0');
      $("s").textContent=String(secs).padStart(2,'0');
      setStatus(true, "ğŸŸ¢ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù†");
    }
    tick();
    timer=setInterval(tick,1000);
  }

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  
  async function firestorePing(){
    try{
      const ref = doc(db, "_health", "ping");
      await getDoc(ref); // not-found still means connected
      cloudStatus.textContent = "âœ… Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firestore)";
      showDebug("");
      return true;
    }catch(e){
      cloudStatus.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
      const details = ((e && (e.code || e.name)) ? (e.code || e.name) : "error") + ": " + (e && e.message ? e.message : String(e));
      showDebug(details + "

Ø­Ù„ÙˆÙ„ Ø³Ø±ÙŠØ¹Ø©:
1) ØªØ£ÙƒØ¯ Firestore Database Ù…ÙØ¹Ù‘Ù„
2) Rules Ù…Ù†Ø´ÙˆØ±Ø© ÙˆØªØ³Ù…Ø­ read/write
3) Ø¬Ø±Ù‘Ø¨ ØªØ­Ø¯ÙŠØ« Ù‚ÙˆÙŠ
4) Ø¥Ø°Ø§ Ø§Ù„Ø´Ø¨ÙƒØ© ØªÙ…Ù†Ø¹ Google Ø¬Ø±Ù‘Ø¨ VPN");
      return false;
    }
  }
  setTimeout(firestorePing, 600);
try{
    await getDoc(doc(db, COLLECTION, "__ping__"));
    $("cloudStatus").textContent = "âœ… Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
  }catch(e){
    $("cloudStatus").textContent = "âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Firestore ÙˆØªØ´ØºÙŠÙ„Ù‡ (test mode)";
  }

  (function initFromURL(){
    const url = new URL(window.location.href);
    const code = url.searchParams.get("code");
    if(code) $("code").value = code;
  })();

  $("activateBtn").addEventListener("click", async () => {
    const fullName = normalizeName($("fullName").value);
    const phone = sanitizePhone($("phone").value);
    const model = ($("model").value || "").trim();
    const address = ($("address").value || "").trim();
    const series = $("series").value;
    const code = ($("code").value || "").trim();

    if(fullName.split(" ").length < 3) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ (3 ÙƒÙ„Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).");
    if(phone.length < 10) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­.");
    if(!model) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø².");
    if(!address) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„.");

    const key = makeKey(fullName, phone);
    const ref = doc(db, COLLECTION, key);

    try{
      const snap = await getDoc(ref);
      if(snap.exists()){
        alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ø³Ø¨Ù‚Ø§Ù‹.");
        return;
      }

      const start = new Date();
      const end = addDays(start, WARRANTY_DAYS);

      await setDoc(ref, {
        key, fullName, phone, model, address, series,
        code: code || null,
        startISO: start.toISOString(),
        endISO: end.toISOString(),
        createdAt: serverTimestamp()
      });

      $("resultBox").classList.remove("hidden");
      $("startDate").textContent = formatDate(start);
      $("endDate").textContent = formatDate(end);
      setStatus(true, "ğŸŸ¢ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù†");
      startCountdown(end);

      $("searchName").value = fullName;
      $("searchPhone").value = phone;

      $("resultBox").scrollIntoView({behavior:"smooth", block:"start"});
    }catch(e){
      alert("ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸. ØªØ£ÙƒØ¯ Ù…Ù† Firestore Rules (test mode) ÙˆÙ…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Øª.");
    }
  });

  $("searchBtn").addEventListener("click", async () => {
    const name = normalizeName($("searchName").value);
    const phone = sanitizePhone($("searchPhone").value);

    if(name.split(" ").length < 3) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ.");
    if(phone.length < 10) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.");

    const key = makeKey(name, phone);
    const ref = doc(db, COLLECTION, key);

    try{
      const snap = await getDoc(ref);
      if(!snap.exists()){
        $("searchResult").classList.add("hidden");
        $("searchNote").textContent = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø±Ù‚Ù….";
        return;
      }

      const rec = snap.data();
      $("rName").textContent = rec.fullName || "";
      $("rPhone").textContent = rec.phone || "";
      $("rModel").textContent = rec.model || "";
      $("rSeries").textContent = rec.series || "";

      const end = new Date(rec.endISO);
      $("rEnd").textContent = formatDate(end);

      const active = (new Date()) <= end;
      if(active){
        $("searchDot").className = "dot";
        $("searchStatusText").textContent = "ğŸŸ¢ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶Ù…Ø§Ù†";
      }else{
        $("searchDot").className = "dot bad";
        $("searchStatusText").textContent = "ğŸ”´ Ø§Ù„Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù†Ø§ÙØ°";
      }

      $("searchNote").textContent = "";
      $("searchResult").classList.remove("hidden");
      $("searchResult").scrollIntoView({behavior:"smooth", block:"start"});
    }catch(e){
      $("searchResult").classList.add("hidden");
      $("searchNote").textContent = "âš ï¸ Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.";
    }
  });

  $("callHelp").addEventListener("click", () => window.location.href = `tel:${HELP_PHONE}`);
  $("callHelp2").addEventListener("click", () => window.location.href = `tel:${HELP_PHONE}`);
  $("backBtn").addEventListener("click", showActivate);

  $("copyInfo").addEventListener("click", async () => {
    const text =
`Ø´Ø±ÙƒØ© Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©
Ø§Ù„Ø§Ø³Ù…: ${$("fullName").value}
Ø§Ù„Ù‡Ø§ØªÙ: ${$("phone").value}
Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: ${$("model").value}
Ø§Ù„Ø³Ù„Ø³Ù„Ø©: ${$("series").value}
Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¶Ù…Ø§Ù†: ${$("startDate").textContent}
Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†: ${$("endDate").textContent}`;
    try{
      await navigator.clipboard.writeText(text);
      const old = $("copyInfo").textContent;
      $("copyInfo").textContent = "ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“";
      setTimeout(()=> $("copyInfo").textContent = old, 1100);
    }catch(e){
      alert("Ù…Ø§Ú¯Ø¯Ø±Ù†Ø§ Ù†Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹:\n\n" + text);
    }
  });

  showActivate();
</script>
</body>
</html>
